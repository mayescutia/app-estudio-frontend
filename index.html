<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üìö Estudio Diario ‚Äî Rememoraci√≥n Activa</title>
    <link href="https://fonts.googleapis.com/css2?family=Crimson+Pro:wght@400;600;700&family=DM+Sans:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        :root {
            --bg-primary: #faf8f5;
            --bg-card: #ffffff;
            --text-primary: #2c2416;
            --text-secondary: #6b6658;
            --accent-primary: #d97706;
            --accent-secondary: #0891b2;
            --accent-tertiary: #059669;
            --border-color: #e7e5df;
            --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.04);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.08), 0 2px 4px -1px rgba(0, 0, 0, 0.04);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        /* Modo oscuro */
        body.dark-mode {
            --bg-primary: #1a1a1a;
            --bg-card: #262626;
            --text-primary: #e5e5e5;
            --text-secondary: #a3a3a3;
            --border-color: #404040;
            --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.3);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.4), 0 2px 4px -1px rgba(0, 0, 0, 0.3);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.5), 0 4px 6px -2px rgba(0, 0, 0, 0.4);
        }

        body.dark-mode .comparison-item.match {
            background: linear-gradient(135deg, #1a2e1a 0%, #2d4a2d 100%);
        }

        body.dark-mode .comparison-item.missing {
            background: linear-gradient(135deg, #2e1a1a 0%, #4a2d2d 100%);
        }

        body.dark-mode .comparison-item.extra {
            background: linear-gradient(135deg, #2e2a1a 0%, #4a452d 100%);
        }

        body.dark-mode .tip {
            background: linear-gradient(135deg, #1a2e1a 0%, #2d4a2d 100%);
        }

        body.dark-mode .quiz-card {
            background: var(--bg-card);
            border-color: var(--accent-primary);
        }

        body.dark-mode #pomodoroTimer {
            background: var(--bg-card);
        }

        body.dark-mode #darkModeToggle {
            background: var(--bg-card);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'DM Sans', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
            padding: 2rem 1rem;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            animation: fadeIn 0.6s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        header {
            text-align: center;
            margin-bottom: 3rem;
            padding-bottom: 2rem;
            border-bottom: 2px solid var(--accent-primary);
            animation: slideDown 0.8s ease-out;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        h1 {
            font-family: 'Crimson Pro', serif;
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
            letter-spacing: -0.02em;
        }

        .subtitle {
            font-size: 1.1rem;
            color: var(--text-secondary);
            font-weight: 400;
        }

        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem 1rem;
            box-shadow: var(--shadow-sm);
            border: 2px solid var(--border-color);
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-md);
            border-color: var(--accent-primary);
        }

        .stat-number {
            font-family: 'Crimson Pro', serif;
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--accent-primary);
            margin-bottom: 0.5rem;
        }

        .stat-label {
            font-size: 0.9rem;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .section {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: var(--shadow-md);
            border-left: 4px solid transparent;
            transition: all 0.3s ease;
            animation: fadeInUp 0.6s ease-out backwards;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .section:nth-child(1) {
            animation-delay: 0.1s;
            border-left-color: var(--accent-primary);
        }

        .section:nth-child(2) {
            animation-delay: 0.2s;
            border-left-color: var(--accent-secondary);
        }

        .section:nth-child(3) {
            animation-delay: 0.3s;
            border-left-color: var(--accent-tertiary);
        }

        .section:nth-child(4) {
            animation-delay: 0.4s;
            border-left-color: #dc2626;
        }

        .section:nth-child(5) {
            animation-delay: 0.5s;
            border-left-color: #7c3aed;
        }

        .section:nth-child(6) {
            animation-delay: 0.6s;
            border-left-color: #dc2626;
        }

        .section:nth-child(7) {
            animation-delay: 0.7s;
            border-left-color: #059669;
        }

        .section:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .section.disabled {
            opacity: 0.6;
            pointer-events: none;
        }

        .section-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1.5rem;
        }

        .section-number {
            font-family: 'Crimson Pro', serif;
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--accent-primary);
            min-width: 2rem;
        }

        h2 {
            font-family: 'Crimson Pro', serif;
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
            flex: 1;
        }

        .badge {
            display: inline-block;
            background: var(--accent-primary);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-left: 0.5rem;
        }

        .badge.success {
            background: var(--accent-tertiary);
        }

        textarea {
            width: 100%;
            min-height: 150px;
            padding: 1rem;
            font-family: 'DM Sans', sans-serif;
            font-size: 1rem;
            line-height: 1.6;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            resize: vertical;
            transition: all 0.3s ease;
            background: var(--bg-card);
            color: var(--text-primary);
        }

        textarea:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(217, 119, 6, 0.1);
        }

        .btn {
            background: var(--accent-primary);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-family: 'DM Sans', sans-serif;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 1rem;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn:hover {
            background: #b45309;
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .btn:disabled {
            background: #d1d5db;
            cursor: not-allowed;
            transform: none;
        }

        .btn.secondary {
            background: var(--accent-secondary);
        }

        .btn.secondary:hover {
            background: #0e7490;
        }

        .content-box {
            background: var(--bg-primary);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            padding: 1.5rem;
            min-height: 120px;
            margin-top: 1rem;
        }

        .content-box.highlight {
            background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
            border-left: 4px solid var(--accent-primary);
        }

        .loading {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            color: var(--text-secondary);
            font-style: italic;
        }

        .spinner {
            width: 20px;
            height: 20px;
            border: 3px solid var(--border-color);
            border-top-color: var(--accent-primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .comparison-item {
            padding: 1rem;
            margin-bottom: 0.75rem;
            border-radius: 8px;
            border-left: 4px solid;
        }

        .comparison-item.match {
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
            border-left-color: var(--accent-tertiary);
        }

        .comparison-item.missing {
            background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
            border-left-color: #dc2626;
        }

        .comparison-item.extra {
            background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
            border-left-color: var(--accent-secondary);
        }

        .comparison-label {
            font-weight: 600;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .study-card {
            background: white;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            padding: 1.25rem;
            margin-bottom: 1rem;
            transition: all 0.3s ease;
        }

        .study-card:hover {
            border-color: var(--accent-primary);
            box-shadow: var(--shadow-sm);
        }

        .study-card-question {
            font-weight: 600;
            color: var(--accent-primary);
            margin-bottom: 0.75rem;
            font-size: 1.05rem;
        }

        .study-card-answer {
            color: var(--text-secondary);
            line-height: 1.7;
        }

        .questions {
            list-style: none;
            padding-left: 0;
        }

        .questions li {
            padding: 1rem;
            margin-bottom: 0.75rem;
            background: linear-gradient(135deg, #fdf4ff 0%, #fae8ff 100%);
            border-left: 4px solid #db2777;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .questions li:hover {
            transform: translateX(5px);
            box-shadow: var(--shadow-sm);
        }

        .questions li::before {
            content: "‚Üí";
            color: #db2777;
            font-weight: 700;
            margin-right: 0.75rem;
        }

        footer {
            text-align: center;
            margin-top: 4rem;
            padding-top: 2rem;
            border-top: 2px solid var(--border-color);
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .tip {
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
            border-left: 4px solid var(--accent-tertiary);
            padding: 1rem 1.25rem;
            border-radius: 8px;
            margin-top: 1rem;
            font-size: 0.95rem;
        }

        .tip::before {
            content: "üí° ";
            font-size: 1.2rem;
            margin-right: 0.5rem;
        }

        #aiAnalysis {
            margin-top: 1.5rem;
            animation: fadeInUp 0.5s ease-out;
        }

        #aiAnalysisContent {
            line-height: 1.8;
        }

        #aiAnalysisContent h3 {
            color: var(--accent-primary);
            margin-top: 1.5rem;
            margin-bottom: 0.75rem;
            font-size: 1.1rem;
        }

        #aiAnalysisContent h3:first-child {
            margin-top: 0;
        }

        #aiAnalysisContent ul {
            margin-left: 1.5rem;
            margin-bottom: 1rem;
        }

        #aiAnalysisContent li {
            margin-bottom: 0.5rem;
        }

        #aiAnalysisContent strong {
            color: var(--text-primary);
            font-weight: 600;
        }

        #aiAnalysisContent p {
            margin-bottom: 0.75rem;
        }

        .error-item {
            background: white;
            border-left: 4px solid #dc2626;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            box-shadow: var(--shadow-sm);
        }

        .error-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .error-item-title {
            font-weight: 600;
            color: #dc2626;
            font-size: 0.9rem;
        }

        .error-item-time {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .error-item-content {
            color: var(--text-primary);
            line-height: 1.6;
        }

        .card-item {
            background: white;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            padding: 1.25rem;
            margin-bottom: 1rem;
            transition: all 0.3s ease;
        }

        .card-item:hover {
            border-color: var(--accent-tertiary);
            box-shadow: var(--shadow-sm);
            transform: translateY(-2px);
        }

        .card-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }

        .card-item-number {
            font-weight: 600;
            color: var(--accent-tertiary);
            font-size: 0.85rem;
        }

        .card-item-time {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .card-item-question {
            font-weight: 600;
            color: var(--accent-primary);
            margin-bottom: 0.5rem;
            font-size: 1.05rem;
        }

        .card-item-answer {
            color: var(--text-secondary);
            line-height: 1.7;
        }

        .reset-btn {
            background: white;
            border: 2px solid var(--border-color);
            color: var(--text-primary);
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-family: 'DM Sans', sans-serif;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 1.5rem;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .reset-btn:hover {
            background: var(--bg-primary);
            border-color: var(--accent-primary);
            transform: translateY(-2px);
        }

        .filter-btn {
            padding: 0.5rem 1rem;
            border: 2px solid var(--border-color);
            background: white;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'DM Sans', sans-serif;
        }

        .filter-btn:hover {
            border-color: var(--accent-primary);
            background: var(--bg-primary);
        }

        .filter-btn.active {
            background: var(--accent-primary);
            color: white;
            border-color: var(--accent-primary);
        }

        .stats-card {
            background: white;
            border: 2px solid var(--border-color);
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: var(--shadow-sm);
        }

        .error-frequency-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            background: var(--bg-primary);
            border-radius: 8px;
            border-left: 3px solid var(--accent-primary);
        }

        .error-frequency-text {
            flex: 1;
            font-size: 0.9rem;
            color: var(--text-primary);
        }

        .error-frequency-count {
            background: var(--accent-primary);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-weight: 600;
            font-size: 0.85rem;
        }

        .tag-badge {
            display: inline-block;
            padding: 0.35rem 0.75rem;
            background: var(--bg-primary);
            border: 2px solid var(--border-color);
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .tag-badge:hover {
            background: var(--accent-primary);
            color: white;
            border-color: var(--accent-primary);
        }

        .tag-badge.active {
            background: var(--accent-primary);
            color: white;
            border-color: var(--accent-primary);
        }

        .quiz-card {
            background: white;
            border: 2px solid var(--accent-primary);
            border-radius: 12px;
            padding: 2rem;
            box-shadow: var(--shadow-lg);
        }

        .quiz-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--border-color);
        }

        .quiz-question {
            font-family: 'Crimson Pro', serif;
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--text-primary);
            line-height: 1.6;
            margin: 1.5rem 0;
        }

        .quiz-actions {
            margin-top: 2rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        #difficultyButtons {
            display: flex;
            flex-wrap: wrap;
        }

        .highlight-match {
            background: #dcfce7;
            padding: 0.15rem 0.3rem;
            border-radius: 3px;
        }

        .highlight-missing {
            background: #fee2e2;
            padding: 0.15rem 0.3rem;
            border-radius: 3px;
        }

        .highlight-extra {
            background: #fef3c7;
            padding: 0.15rem 0.3rem;
            border-radius: 3px;
        }

        .icon-btn {
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1.5rem;
            transition: all 0.3s ease;
        }

        .icon-btn:hover {
            transform: scale(1.1);
            border-color: var(--accent-primary);
        }

        #pomodoroTimer {
            padding: 0.75rem 1rem;
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            transition: all 0.3s ease;
        }

        #pomodoroTimer:hover {
            border-color: var(--accent-primary);
            transform: translateY(-2px);
        }

        #pomodoroTimer.active {
            border-color: var(--accent-tertiary);
            box-shadow: 0 0 0 3px rgba(5, 150, 105, 0.1);
        }

        .notes-area {
            margin-top: 1rem;
            padding: 1rem;
            background: var(--bg-primary);
            border: 2px dashed var(--border-color);
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .notes-area:focus-within {
            border-color: var(--accent-primary);
            border-style: solid;
        }

        .pagination-controls {
            display: flex;
            justify-content: center;
            gap: 0.5rem;
            margin-top: 1.5rem;
            flex-wrap: wrap;
        }

        .page-btn {
            padding: 0.5rem 1rem;
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'DM Sans', sans-serif;
            font-weight: 600;
        }

        .page-btn:hover {
            border-color: var(--accent-primary);
            background: var(--accent-primary);
            color: white;
        }

        .page-btn.active {
            background: var(--accent-primary);
            color: white;
            border-color: var(--accent-primary);
        }

        /* Estilos del Tracker */
        .tab-btn {
            padding: 1rem 2rem;
            background: transparent;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-family: 'DM Sans', sans-serif;
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-secondary);
            transition: all 0.3s ease;
        }

        .tab-btn:hover {
            color: var(--text-primary);
        }

        .tab-btn.active {
            color: var(--accent-primary);
            border-bottom-color: var(--accent-primary);
        }

        .tracker-section {
            animation: fadeIn 0.6s ease-out;
        }

        .tracker-card {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: var(--shadow-md);
            border-left: 4px solid var(--accent-primary);
        }

        .metric-card {
            background: var(--bg-primary);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            padding: 1.5rem;
            text-align: center;
            transition: all 0.3s ease;
        }

        .metric-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-md);
            border-color: var(--accent-primary);
        }

        .metric-value {
            font-family: 'Crimson Pro', serif;
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--accent-primary);
            margin-bottom: 0.5rem;
        }

        .metric-label {
            font-size: 0.9rem;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .metric-bar {
            width: 100%;
            height: 8px;
            background: var(--border-color);
            border-radius: 4px;
            margin-top: 0.75rem;
            overflow: hidden;
        }

        .metric-bar-fill {
            height: 100%;
            background: var(--accent-primary);
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        .law-item {
            background: white;
            border: 2px solid var(--border-color);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            transition: all 0.3s ease;
        }

        .law-item:hover {
            border-color: var(--accent-primary);
            box-shadow: var(--shadow-sm);
        }

        .law-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .law-title {
            font-family: 'Crimson Pro', serif;
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .law-score {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--accent-primary);
        }

        .law-progress-bar {
            width: 100%;
            height: 12px;
            background: var(--border-color);
            border-radius: 6px;
            overflow: hidden;
            margin-bottom: 0.75rem;
        }

        .law-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-tertiary), var(--accent-primary));
            border-radius: 6px;
            transition: width 0.5s ease;
        }

        .law-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 0.75rem;
            margin-top: 1rem;
        }

        .law-stat {
            text-align: center;
            padding: 0.5rem;
            background: var(--bg-primary);
            border-radius: 8px;
        }

        .law-stat-value {
            font-weight: 700;
            color: var(--accent-primary);
            font-size: 1.1rem;
        }

        .law-stat-label {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .article-item {
            background: white;
            border: 2px solid var(--border-color);
            border-left: 4px solid var(--accent-secondary);
            border-radius: 8px;
            padding: 1.25rem;
            margin-bottom: 1rem;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .article-item:hover {
            transform: translateX(5px);
            box-shadow: var(--shadow-sm);
        }

        .article-item.mastered {
            border-left-color: var(--accent-tertiary);
        }

        .article-item.weak {
            border-left-color: #dc2626;
        }

        .article-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }

        .article-id {
            font-weight: 700;
            font-size: 1.1rem;
            color: var(--text-primary);
        }

        .article-status {
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .article-status.mastered {
            background: #dcfce7;
            color: #059669;
        }

        .article-status.inprogress {
            background: #fef3c7;
            color: #d97706;
        }

        .article-status.notstarted {
            background: var(--bg-primary);
            color: var(--text-secondary);
        }

        .article-mini-stats {
            display: flex;
            gap: 1rem;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .recommendation-item {
            background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
            border-left: 4px solid var(--accent-primary);
            padding: 1.25rem;
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        .recommendation-title {
            font-weight: 700;
            color: var(--accent-primary);
            margin-bottom: 0.5rem;
        }

        body.dark-mode .law-item,
        body.dark-mode .article-item,
        body.dark-mode .metric-card {
            background: var(--bg-card);
        }

        body.dark-mode .recommendation-item {
            background: linear-gradient(135deg, #2e2a1a 0%, #3a3520 100%);
        }

        @media (max-width: 768px) {
            body {
                padding: 1rem 0.5rem;
            }

            h1 {
                font-size: 2rem;
            }

            .section {
                padding: 1.5rem;
            }

            .section-header {
                flex-direction: column;
                align-items: flex-start;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Navegaci√≥n de pesta√±as -->
        <nav style="display: flex; gap: 1rem; margin-bottom: 2rem; border-bottom: 2px solid var(--border-color); padding-bottom: 1rem; flex-wrap: wrap;">
            <button class="tab-btn active" onclick="switchTab('study')" id="tabStudy">
                üìö Estudio
            </button>
            <button class="tab-btn" onclick="switchTab('tracker')" id="tabTracker">
                üìä Tracker de Progreso
            </button>
            <button class="tab-btn" onclick="switchTab('tools')" id="tabTools">
                üöÄ Herramientas PRO
            </button>
        </nav>

        <!-- Contenedor de Estudio (original) -->
        <div id="studyContent">
        <header>
            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem;">
                <div style="flex: 1;">
                    <h1>üìö Estudio Diario ‚Äî Rememoraci√≥n Activa</h1>
                    <p class="subtitle">Aplicaci√≥n con IA para mejorar la retenci√≥n y el aprendizaje profundo</p>
                </div>
                <div style="display: flex; gap: 1rem; align-items: center;">
                    <!-- Temporizador Pomodoro -->
                    <div id="pomodoroTimer" style="text-align: center; background: white; padding: 1rem; border-radius: 12px; border: 2px solid var(--border-color); min-width: 150px;">
                        <div style="font-size: 1.8rem; font-weight: 700; color: var(--accent-primary); font-family: 'Crimson Pro', serif;" id="timerDisplay">25:00</div>
                        <div style="font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 0.5rem;" id="timerLabel">Enfoque</div>
                        <div style="display: flex; gap: 0.5rem; justify-content: center;">
                            <button onclick="togglePomodoro()" id="pomodoroBtn" style="padding: 0.35rem 0.75rem; border: none; background: var(--accent-primary); color: white; border-radius: 6px; cursor: pointer; font-size: 0.8rem; font-weight: 600;">‚ñ∂ Iniciar</button>
                            <button onclick="resetPomodoro()" style="padding: 0.35rem 0.75rem; border: none; background: var(--text-secondary); color: white; border-radius: 6px; cursor: pointer; font-size: 0.8rem;">‚Üª</button>
                        </div>
                    </div>
                    <!-- Toggle modo oscuro -->
                    <button onclick="toggleDarkMode()" id="darkModeToggle" style="padding: 0.75rem; background: white; border: 2px solid var(--border-color); border-radius: 12px; cursor: pointer; font-size: 1.5rem; line-height: 1;">
                        üåô
                    </button>
                </div>
            </div>
            
            <!-- Estad√≠sticas de progreso -->
            <div id="statsPanel" style="margin-top: 2rem; display: none;">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; text-align: center;">
                    <div class="stat-card">
                        <div class="stat-number" id="totalArticles">0</div>
                        <div class="stat-label">Art√≠culos Estudiados</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="totalErrors">0</div>
                        <div class="stat-label">Errores Totales</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="totalCards">0</div>
                        <div class="stat-label">Tarjetas Creadas</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="avgAccuracy">0%</div>
                        <div class="stat-label">Precisi√≥n Promedio</div>
                    </div>
                </div>
            </div>
        </header>

        <div class="section">
            <div class="section-header">
                <span class="section-number">1.</span>
                <h2>ART√çCULO ORIGINAL</h2>
                <div style="display: flex; align-items: center; gap: 1rem;">
                    <div id="sessionTimer" style="font-family: 'Crimson Pro', serif; font-size: 1.5rem; font-weight: 700; color: var(--accent-primary);">00:00</div>
                    <button onclick="toggleSessionTimer()" id="timerToggle" class="icon-btn" style="width: auto; padding: 0.5rem 1rem; border-radius: 8px;">
                        ‚è∏Ô∏è Pausar
                    </button>
                </div>
            </div>
            
            <!-- Identificaci√≥n del art√≠culo y apartado -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                <div>
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--text-primary);">
                        üìú Art√≠culo / Ley
                    </label>
                    <input 
                        type="text" 
                        id="articleNumber" 
                        placeholder="Ej: C√≥digo Civil Art. 1255"
                        style="width: 100%; padding: 0.75rem; border: 2px solid var(--border-color); border-radius: 8px; font-family: 'DM Sans', sans-serif; font-size: 0.95rem;"
                    />
                </div>
                <div>
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--text-primary);">
                        üìë Apartado / Secci√≥n
                    </label>
                    <input 
                        type="text" 
                        id="articleSection" 
                        placeholder="Ej: Apartado 1, Letra a), ¬ß2..."
                        style="width: 100%; padding: 0.75rem; border: 2px solid var(--border-color); border-radius: 8px; font-family: 'DM Sans', sans-serif; font-size: 0.95rem;"
                    />
                </div>
            </div>
            
            <!-- Sistema de etiquetas -->
            <div style="margin-bottom: 1rem;">
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--text-primary);">
                    üè∑Ô∏è Etiquetas (separadas por comas)
                </label>
                <input 
                    type="text" 
                    id="articleTags" 
                    placeholder="Ej: contratos, obligaciones, civil, examen-final"
                    style="width: 100%; padding: 0.75rem; border: 2px solid var(--border-color); border-radius: 8px; font-family: 'DM Sans', sans-serif; font-size: 0.95rem;"
                />
                <div style="margin-top: 0.5rem; display: flex; gap: 0.5rem; flex-wrap: wrap;" id="suggestedTags"></div>
            </div>
            
            <p style="color: var(--text-secondary); margin-bottom: 1rem;">
                Pega aqu√≠ el apartado espec√≠fico del art√≠culo que quieres estudiar.
            </p>
            <textarea id="originalText" placeholder="Pega aqu√≠ el apartado del art√≠culo que vas a estudiar (ejemplo: el apartado 1 del art√≠culo 1255 del C√≥digo Civil)...">Los contratos pueden ser verbales o por escrito. Se entiende que existe siempre que hay una relaci√≥n en la que una persona presta unos servicios para otro por los que recibe una contraprestaci√≥n.</textarea>
            
            <!-- Notas personales -->
            <div style="margin-top: 1rem;">
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--text-primary);">
                    üìù Notas Personales (Mnemotecnias, trucos de memoria, etc.)
                </label>
                <textarea 
                    id="personalNotes" 
                    placeholder="Ejemplo: 'Recuerda CON-TRA-TO = CON palabras o TRAzos en papel. Verbal u Oral'"
                    style="width: 100%; min-height: 80px; padding: 0.75rem; border: 2px solid var(--border-color); border-radius: 8px; font-family: 'DM Sans', sans-serif; font-size: 0.95rem; background: #fffbeb;"
                ></textarea>
            </div>
        </div>

        <div class="section">
            <div class="section-header">
                <span class="section-number">2.</span>
                <h2>RECUERDO LIBRE <span class="badge">Sin mirar</span></h2>
            </div>
            <p style="color: var(--text-secondary); margin-bottom: 1rem;">
                Sin mirar el art√≠culo original, escribe todo lo que recuerdas.
            </p>
            <textarea id="recallText" placeholder="Escribe aqu√≠ lo que recuerdas del art√≠culo original sin mirarlo..."></textarea>
            
            <!-- Notas y mnemotecnias -->
            <div class="notes-area">
                <label style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: var(--text-primary);">
                    üìù Notas Personales y Mnemotecnias
                </label>
                <textarea id="personalNotes" placeholder="A√±ade aqu√≠ mnemotecnias, trucos para recordar, anotaciones personales..." style="width: 100%; min-height: 80px; border: none; background: transparent; padding: 0.5rem; font-size: 0.95rem; resize: vertical;"></textarea>
            </div>
            
            <button class="btn" id="compareBtn" onclick="compareTexts()">
                üîç Comparar y Analizar
            </button>
        </div>

        <div class="section disabled" id="section3">
            <div class="section-header">
                <span class="section-number">3.</span>
                <h2>COMPARACI√ìN AUTOM√ÅTICA</h2>
                <span class="badge" id="similarityBadge" style="display: none; background: var(--accent-tertiary);">0% similitud</span>
            </div>
            
            <!-- Comparaci√≥n visual palabra por palabra -->
            <div id="visualComparison" style="display: none; margin-bottom: 1.5rem;">
                <h3 style="font-family: 'Crimson Pro', serif; margin-bottom: 1rem; font-size: 1.1rem; color: var(--text-primary);">
                    üîç Comparaci√≥n Visual Palabra por Palabra
                </h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div>
                        <div style="font-weight: 600; margin-bottom: 0.5rem; color: var(--text-secondary);">Original</div>
                        <div id="originalHighlighted" style="padding: 1rem; background: white; border-radius: 8px; line-height: 2; border: 2px solid var(--border-color);"></div>
                    </div>
                    <div>
                        <div style="font-weight: 600; margin-bottom: 0.5rem; color: var(--text-secondary);">Tu Recuerdo</div>
                        <div id="recallHighlighted" style="padding: 1rem; background: white; border-radius: 8px; line-height: 2; border: 2px solid var(--border-color);"></div>
                    </div>
                </div>
                <div style="margin-top: 1rem; display: flex; gap: 1rem; font-size: 0.9rem;">
                    <span><span style="background: #dcfce7; padding: 0.25rem 0.5rem; border-radius: 4px;">‚úÖ Correcto</span></span>
                    <span><span style="background: #fee2e2; padding: 0.25rem 0.5rem; border-radius: 4px;">‚ùå Olvidado</span></span>
                    <span><span style="background: #fef3c7; padding: 0.25rem 0.5rem; border-radius: 4px;">‚ö†Ô∏è Extra</span></span>
                </div>
            </div>
            
            <div id="comparisonResult" class="content-box">
                <em style="color: var(--text-secondary);">Completa los pasos 1 y 2, luego haz clic en "Comparar y Analizar"</em>
            </div>
        </div>

        <div class="section disabled" id="section4">
            <div class="section-header">
                <span class="section-number">4.</span>
                <h2>PUNTOS QUE DEBO REPASAR</h2>
            </div>
            <div id="reviewPoints" class="content-box">
                <em style="color: var(--text-secondary);">Los puntos clave para repasar aparecer√°n autom√°ticamente</em>
            </div>
        </div>

        <div class="section disabled" id="section5">
            <div class="section-header">
                <span class="section-number">5.</span>
                <h2>TARJETAS DE ESTUDIO</h2>
            </div>
            <div class="tip">
                Las tarjetas de estudio te ayudar√°n a consolidar los conceptos que m√°s necesitas reforzar.
            </div>
            <div id="studyCards">
                <em style="color: var(--text-secondary);">Las tarjetas de estudio se generar√°n autom√°ticamente</em>
            </div>
        </div>

        <div class="section" id="errorHistory">
            <div class="section-header">
                <span class="section-number">6.</span>
                <h2>HISTORIAL DE ERRORES ACUMULADOS</h2>
                <span class="badge" id="errorCount">0 errores</span>
            </div>
            <div class="tip">
                üìå Todos tus errores y omisiones se acumulan aqu√≠ para que puedas repasarlos al final de tu jornada de estudio.
            </div>
            
            <!-- Barra de b√∫squeda y filtros -->
            <div style="margin-top: 1rem; margin-bottom: 1rem;">
                <input 
                    type="text" 
                    id="searchErrors" 
                    placeholder="üîç Buscar en errores..." 
                    style="width: 100%; padding: 0.75rem; border: 2px solid var(--border-color); border-radius: 8px; font-family: 'DM Sans', sans-serif; font-size: 0.95rem;"
                    onkeyup="filterErrors()"
                />
                <div style="margin-top: 0.75rem; display: flex; gap: 0.5rem; flex-wrap: wrap;">
                    <button class="filter-btn active" onclick="filterByType('all')" data-filter="all">Todos</button>
                    <button class="filter-btn" onclick="filterByType('omission')" data-filter="omission">‚ùå Omisiones</button>
                    <button class="filter-btn" onclick="filterByType('error')" data-filter="error">‚ö†Ô∏è Errores</button>
                </div>
            </div>
            
            <div id="errorHistoryContent" class="content-box">
                <em style="color: var(--text-secondary);">A√∫n no hay errores acumulados. Completa tu primer an√°lisis para empezar.</em>
            </div>
            
            <!-- Controles de paginaci√≥n -->
            <div class="pagination-controls" id="errorPagination" style="display: none;"></div>
            
            <div style="margin-top: 1rem; display: flex; gap: 0.5rem; flex-wrap: wrap;">
                <button class="btn secondary" onclick="exportToPDF()">
                    üìÑ Exportar a PDF
                </button>
                <button class="btn secondary" onclick="exportToJSON()">
                    üíæ Exportar a JSON
                </button>
                <button class="btn secondary" onclick="importFromJSON()">
                    üì• Importar JSON
                </button>
                <button class="btn secondary" onclick="shareProgress()">
                    üì§ Compartir Progreso
                </button>
                <button class="btn secondary" onclick="clearHistory()">
                    üóëÔ∏è Limpiar Historial
                </button>
            </div>
        </div>

        <div class="section" id="cardCollection">
            <div class="section-header">
                <span class="section-number">7.</span>
                <h2>COLECCI√ìN DE TARJETAS DE ESTUDIO</h2>
                <span class="badge success" id="cardCount">0 tarjetas</span>
            </div>
            <div class="tip">
                üé¥ Todas las tarjetas de estudio generadas se acumulan aqu√≠. √ösalas para repasar antes de tu pr√≥xima jornada.
            </div>
            
            <!-- Barra de b√∫squeda para tarjetas -->
            <div style="margin-top: 1rem; margin-bottom: 1rem;">
                <input 
                    type="text" 
                    id="searchCards" 
                    placeholder="üîç Buscar en tarjetas..." 
                    style="width: 100%; padding: 0.75rem; border: 2px solid var(--border-color); border-radius: 8px; font-family: 'DM Sans', sans-serif; font-size: 0.95rem;"
                    onkeyup="filterCards()"
                />
            </div>
            
            <div id="cardCollectionContent">
                <em style="color: var(--text-secondary);">A√∫n no hay tarjetas acumuladas. Completa tu primer an√°lisis para empezar.</em>
            </div>
            
            <!-- Controles de paginaci√≥n -->
            <div class="pagination-controls" id="cardPagination" style="display: none;"></div>
            
            <div style="margin-top: 1rem; display: flex; gap: 0.5rem; flex-wrap: wrap;">
                <button class="btn secondary" onclick="exportCardsToPDF()">
                    üìÑ Exportar a PDF
                </button>
                <button class="btn secondary" onclick="exportCardsToAnki()">
                    üé¥ Exportar para Anki
                </button>
                <button class="btn secondary" onclick="exportCardsToJSON()">
                    üíæ Exportar a JSON
                </button>
                <button class="btn secondary" onclick="clearCards()">
                    üóëÔ∏è Limpiar Tarjetas
                </button>
            </div>
        </div>

        <!-- Nueva secci√≥n de estad√≠sticas avanzadas -->
        <div class="section" id="advancedStats" style="display: none;">
            <div class="section-header">
                <span class="section-number">8.</span>
                <h2>ESTAD√çSTICAS AVANZADAS</h2>
            </div>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; margin-top: 1rem;">
                <!-- Gr√°fico de evoluci√≥n -->
                <div class="stats-card">
                    <h3 style="font-family: 'Crimson Pro', serif; margin-bottom: 1rem; color: var(--accent-primary);">üìà Evoluci√≥n de Precisi√≥n</h3>
                    <canvas id="evolutionChart" style="max-height: 200px;"></canvas>
                </div>
                
                <!-- Errores m√°s frecuentes -->
                <div class="stats-card">
                    <h3 style="font-family: 'Crimson Pro', serif; margin-bottom: 1rem; color: var(--accent-primary);">üî• Errores M√°s Frecuentes</h3>
                    <div id="frequentErrors"></div>
                </div>
                
                <!-- Art√≠culos con m√°s dificultad -->
                <div class="stats-card">
                    <h3 style="font-family: 'Crimson Pro', serif; margin-bottom: 1rem; color: var(--accent-primary);">‚ö†Ô∏è Art√≠culos Dif√≠ciles</h3>
                    <div id="difficultArticles"></div>
                </div>
            </div>
        </div>

        <!-- Nueva secci√≥n de Modo Repaso Inteligente -->
        <div class="section" id="reviewMode" style="display: none;">
            <div class="section-header">
                <span class="section-number">9.</span>
                <h2>MODO REPASO INTELIGENTE</h2>
                <span class="badge success" id="reviewProgress">0/0</span>
            </div>
            
            <div class="tip">
                üß† Sistema de repetici√≥n espaciada: las tarjetas que te cuestan m√°s aparecer√°n con m√°s frecuencia.
            </div>
            
            <div id="quizContainer" style="margin-top: 1.5rem;">
                <!-- Quiz interactivo -->
                <div id="quizCard" class="quiz-card" style="display: none;">
                    <div class="quiz-header">
                        <span id="quizArticle" style="font-weight: 600; color: var(--accent-primary);"></span>
                        <span id="quizCounter" style="color: var(--text-secondary);"></span>
                    </div>
                    
                    <div class="quiz-question" id="quizQuestion"></div>
                    
                    <div id="quizAnswer" style="display: none; margin-top: 1.5rem; padding: 1.5rem; background: var(--bg-primary); border-radius: 8px; border-left: 4px solid var(--accent-tertiary);">
                        <strong style="color: var(--accent-tertiary);">Respuesta:</strong>
                        <div id="quizAnswerText" style="margin-top: 0.5rem;"></div>
                    </div>
                    
                    <div class="quiz-actions">
                        <button class="btn" id="showAnswerBtn" onclick="showQuizAnswer()">
                            üëÅÔ∏è Mostrar Respuesta
                        </button>
                        <div id="difficultyButtons" style="display: none; gap: 0.5rem; margin-top: 1rem;">
                            <button class="btn" style="background: #dc2626;" onclick="rateCard('hard')">
                                üò∞ Dif√≠cil
                            </button>
                            <button class="btn" style="background: #f59e0b;" onclick="rateCard('medium')">
                                üòê Normal
                            </button>
                            <button class="btn" style="background: #059669;" onclick="rateCard('easy')">
                                üòä F√°cil
                            </button>
                            <button class="btn secondary" onclick="rateCard('mastered')">
                                ‚úÖ Dominada
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Controles de inicio -->
                <div id="quizStart" style="text-align: center;">
                    <p style="margin-bottom: 1rem; color: var(--text-secondary);">
                        Repasa tus tarjetas de estudio con el sistema de repetici√≥n espaciada.
                    </p>
                    <button class="btn" onclick="startQuiz()">
                        üéØ Iniciar Repaso
                    </button>
                    <button class="btn secondary" onclick="filterQuizByTag()" style="margin-left: 0.5rem;">
                        üè∑Ô∏è Repasar por Etiqueta
                    </button>
                </div>
                
                <!-- Resumen final -->
                <div id="quizSummary" style="display: none; text-align: center;">
                    <h3 style="font-family: 'Crimson Pro', serif; color: var(--accent-primary); margin-bottom: 1rem;">
                        üéâ ¬°Repaso Completado!
                    </h3>
                    <div id="quizStats" style="margin: 1.5rem 0;"></div>
                    <button class="btn" onclick="startQuiz()">
                        üîÑ Repasar de Nuevo
                    </button>
                </div>
            </div>
        </div>

        <!-- Nueva secci√≥n para compartir progreso -->
        <div class="section" id="shareProgress" style="display: none;">
            <div class="section-header">
                <span class="section-number">10.</span>
                <h2>COMPARTIR PROGRESO</h2>
            </div>
            
            <div class="tip">
                üì§ Comparte tu progreso de estudio con compa√±eros, tutores o en grupos de estudio.
            </div>
            
            <div style="margin-top: 1.5rem; display: grid; gap: 1rem;">
                <button class="btn" onclick="generateShareableReport()">
                    üìä Generar Informe de Progreso
                </button>
                <button class="btn secondary" onclick="shareToClipboard()">
                    üìã Copiar Resumen al Portapapeles
                </button>
                <button class="btn secondary" onclick="exportProgressImage()">
                    üñºÔ∏è Exportar como Imagen
                </button>
            </div>
            
            <div id="sharePreview" style="display: none; margin-top: 1.5rem; padding: 1.5rem; background: white; border: 2px solid var(--border-color); border-radius: 12px;">
                <div id="shareContent"></div>
            </div>
        </div>

        <!-- Indicador de backup autom√°tico -->
        <div id="backupIndicator" style="position: fixed; bottom: 20px; right: 20px; background: var(--accent-tertiary); color: white; padding: 0.75rem 1rem; border-radius: 8px; box-shadow: var(--shadow-lg); display: none; animation: fadeIn 0.3s;">
            üíæ Guardando backup...
        </div>

        <!-- Input oculto para importar archivos -->
        <input type="file" id="fileImport" accept=".json" style="display: none;" onchange="handleFileImport(event)">

        <footer>
            <p>üí° Recuerda: La rememoraci√≥n activa es m√°s efectiva que la simple relectura</p>
            <p style="margin-top: 0.5rem; font-size: 0.85rem;">üìö Tus datos se guardan en tu navegador y persisten entre sesiones</p>
        </footer>
        </div>

        <!-- Contenedor de Tracker (nuevo) -->
        <div id="trackerContent" style="display: none;">
            <!-- Dashboard Principal -->
            <div class="tracker-section">
                <h1 style="font-family: 'Crimson Pro', serif; font-size: 2.5rem; margin-bottom: 1rem;">üìä Tracker de Progreso</h1>
                
                <!-- Resumen General -->
                <div class="tracker-card">
                    <h2 style="font-family: 'Crimson Pro', serif; font-size: 1.5rem; margin-bottom: 1.5rem; color: var(--accent-primary);">üéØ Resumen General</h2>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                        <div class="metric-card">
                            <div class="metric-value" id="trackerTotalArticles">0/0</div>
                            <div class="metric-label">Art√≠culos Estudiados</div>
                            <div class="metric-bar">
                                <div class="metric-bar-fill" id="trackerArticlesBar" style="width: 0%"></div>
                            </div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-value" id="trackerAvgScore">0</div>
                            <div class="metric-label">Nota Media</div>
                            <div class="metric-bar">
                                <div class="metric-bar-fill" id="trackerScoreBar" style="width: 0%; background: var(--accent-tertiary);"></div>
                            </div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-value" id="trackerTotalTime">0h 0m</div>
                            <div class="metric-label">Tiempo Invertido</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-value" id="trackerMastered">0</div>
                            <div class="metric-label">Art√≠culos Dominados</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-value" id="trackerStreak">0 d√≠as</div>
                            <div class="metric-label">Racha de Estudio</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-value" id="trackerDailyAvg">0</div>
                            <div class="metric-label">Art√≠culos/D√≠a</div>
                        </div>
                    </div>
                </div>

                <!-- Progreso por Ley -->
                <div class="tracker-card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                        <h2 style="font-family: 'Crimson Pro', serif; font-size: 1.5rem; color: var(--accent-primary);">üìö Progreso por Ley</h2>
                        <button class="btn secondary" onclick="addNewLaw()">‚ûï A√±adir Ley</button>
                    </div>
                    <div id="lawProgressList"></div>
                </div>

                <!-- Gr√°ficos de Evoluci√≥n -->
                <div class="tracker-card">
                    <h2 style="font-family: 'Crimson Pro', serif; font-size: 1.5rem; margin-bottom: 1.5rem; color: var(--accent-primary);">üìà Evoluci√≥n Temporal</h2>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 1.5rem;">
                        <div>
                            <h3 style="font-size: 1.1rem; margin-bottom: 1rem;">Art√≠culos Estudiados</h3>
                            <canvas id="articlesChart" style="max-height: 250px;"></canvas>
                        </div>
                        <div>
                            <h3 style="font-size: 1.1rem; margin-bottom: 1rem;">Nota Media por Sesi√≥n</h3>
                            <canvas id="scoresChart" style="max-height: 250px;"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Lista Detallada de Art√≠culos -->
                <div class="tracker-card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                        <h2 style="font-family: 'Crimson Pro', serif; font-size: 1.5rem; color: var(--accent-primary);">üìú Detalle por Art√≠culo</h2>
                        <div style="display: flex; gap: 0.5rem;">
                            <select id="filterLaw" onchange="filterArticlesByLaw()" style="padding: 0.5rem; border: 2px solid var(--border-color); border-radius: 8px; background: var(--bg-card);">
                                <option value="all">Todas las leyes</option>
                            </select>
                            <select id="filterStatus" onchange="filterArticlesByLaw()" style="padding: 0.5rem; border: 2px solid var(--border-color); border-radius: 8px; background: var(--bg-card);">
                                <option value="all">Todos los estados</option>
                                <option value="mastered">‚úÖ Dominados</option>
                                <option value="inprogress">üü° En progreso</option>
                                <option value="notstarted">‚ö™ No iniciados</option>
                            </select>
                        </div>
                    </div>
                    <div id="articleDetailList"></div>
                </div>

                <!-- An√°lisis y Recomendaciones -->
                <div class="tracker-card">
                    <h2 style="font-family: 'Crimson Pro', serif; font-size: 1.5rem; margin-bottom: 1.5rem; color: var(--accent-primary);">üí° An√°lisis y Recomendaciones</h2>
                    <div id="recommendations"></div>
                </div>

                <!-- Planificador de Examen -->
                <div class="tracker-card">
                    <h2 style="font-family: 'Crimson Pro', serif; font-size: 1.5rem; margin-bottom: 1.5rem; color: var(--accent-primary);">üìÖ Planificador de Examen</h2>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem;">
                        <div>
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Fecha del Examen</label>
                            <input type="date" id="examDate" onchange="calculatePlan()" style="width: 100%; padding: 0.75rem; border: 2px solid var(--border-color); border-radius: 8px; background: var(--bg-card);">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Total de Art√≠culos a Estudiar</label>
                            <input type="number" id="totalArticlesGoal" value="500" onchange="calculatePlan()" style="width: 100%; padding: 0.75rem; border: 2px solid var(--border-color); border-radius: 8px; background: var(--bg-card);">
                        </div>
                    </div>
                    <div id="planResult" style="margin-top: 1.5rem;"></div>
                </div>

                <!-- Modo Examen -->
                <div class="tracker-card">
                    <h2 style="font-family: 'Crimson Pro', serif; font-size: 1.5rem; margin-bottom: 1.5rem; color: var(--accent-primary);">üéØ Modo Examen</h2>
                    <p style="color: var(--text-secondary); margin-bottom: 1rem;">Simula un examen con art√≠culos aleatorios de tu progreso</p>
                    <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                        <button class="btn" onclick="startExamMode('all')">üìù Examen Completo</button>
                        <button class="btn secondary" onclick="startExamMode('weak')">‚ö†Ô∏è Solo Art√≠culos D√©biles</button>
                        <button class="btn secondary" onclick="startExamMode('random')">üé≤ 10 Art√≠culos Aleatorios</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Contenedor de Herramientas PRO (NUEVO) -->
        <div id="toolsContent" style="display: none;">
            <div class="tracker-section">
                <h1 style="font-family: 'Crimson Pro', serif; font-size: 2.5rem; margin-bottom: 1rem;">üöÄ Herramientas PRO</h1>
                <p style="color: var(--text-secondary); font-size: 1.1rem; margin-bottom: 3rem;">Las 5 mejoras m√°s potentes integradas en una sola pesta√±a</p>

                <!-- MEJORA #1: CRON√ìMETRO -->
                <div class="tracker-card" style="border-left-color: #d97706;">
                    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem; margin-bottom: 1.5rem;">
                        <div style="flex: 1; min-width: 250px;">
                            <h2 style="font-family: 'Crimson Pro', serif; font-size: 1.8rem; color: #d97706;">‚è±Ô∏è Cron√≥metro de Sesi√≥n</h2>
                            <p style="color: var(--text-secondary); margin-top: 0.5rem;">Tiempo real de estudio</p>
                        </div>
                        <div style="font-size: 3rem;">ü•á</div>
                    </div>

                    <div style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border: 3px solid #d97706; border-radius: 16px; padding: 2rem; text-align: center;">
                        <div id="proSessionTimer" style="font-family: 'Crimson Pro', serif; font-size: 4rem; font-weight: 700; color: #d97706; margin: 1rem 0;">00:00:00</div>
                        
                        <div style="display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap; margin: 1.5rem 0;">
                            <button class="btn" onclick="toggleProTimer()" id="proTimerBtn" style="background: #059669; padding: 1rem 2rem;">‚ñ∂Ô∏è Iniciar</button>
                            <button class="btn secondary" onclick="resetProTimer()" style="padding: 1rem 2rem;">üîÑ Reiniciar</button>
                        </div>

                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); gap: 0.75rem; margin-top: 1rem;">
                            <div style="background: white; padding: 0.75rem; border-radius: 8px;">
                                <div style="font-size: 1.3rem; font-weight: 700; color: #d97706;" id="proTodayCount">0</div>
                                <div style="font-size: 0.8rem; color: #92400e;">Arts. hoy</div>
                            </div>
                            <div style="background: white; padding: 0.75rem; border-radius: 8px;">
                                <div style="font-size: 1.3rem; font-weight: 700; color: #d97706;" id="proTodayTime">0m</div>
                                <div style="font-size: 0.8rem; color: #92400e;">Total hoy</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- MEJORA #2: NUBE -->
                <div class="tracker-card" style="border-left-color: #0891b2;">
                    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem; margin-bottom: 1.5rem;">
                        <div style="flex: 1; min-width: 250px;">
                            <h2 style="font-family: 'Crimson Pro', serif; font-size: 1.8rem; color: #0891b2;">‚òÅÔ∏è Sincronizaci√≥n en la Nube</h2>
                            <p style="color: var(--text-secondary); margin-top: 0.5rem;">Backup autom√°tico y seguro</p>
                        </div>
                        <div style="font-size: 3rem;">ü•à</div>
                    </div>

                    <div style="background: linear-gradient(135deg, #ecfeff 0%, #cffafe 100%); border: 3px solid #0891b2; border-radius: 16px; padding: 1.5rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; padding: 1rem; background: white; border-radius: 8px; flex-wrap: wrap; gap: 1rem;">
                            <div style="flex: 1; min-width: 200px;">
                                <div style="font-weight: 700; color: #0c4a6e;">Estado</div>
                                <div style="font-size: 0.9rem; color: #64748b;">√öltima: <span id="proLastSync">Nunca</span></div>
                            </div>
                            <div id="proSyncStatus" style="padding: 0.5rem 1rem; background: #6b7280; color: white; border-radius: 16px; font-size: 0.8rem; font-weight: 700;">‚ö™ No sincronizado</div>
                        </div>

                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 0.75rem;">
                            <button class="btn" onclick="proSyncNow()" style="background: #0891b2; padding: 0.75rem; font-size: 0.9rem;">‚òÅÔ∏è Guardar</button>
                            <button class="btn" onclick="proLoadCloud()" style="background: #059669; padding: 0.75rem; font-size: 0.9rem;">üì• Cargar</button>
                            <button class="btn secondary" onclick="proToggleAutoSync()" id="proAutoSyncBtn" style="padding: 0.75rem; font-size: 0.9rem;">üîÑ Auto: OFF</button>
                            <button class="btn secondary" onclick="proDownloadBackup()" style="padding: 0.75rem; font-size: 0.9rem;">üíæ Backup</button>
                        </div>
                    </div>
                </div>

                <!-- MEJORA #3: PDF -->
                <div class="tracker-card" style="border-left-color: #7c3aed;">
                    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem; margin-bottom: 1.5rem;">
                        <div style="flex: 1; min-width: 250px;">
                            <h2 style="font-family: 'Crimson Pro', serif; font-size: 1.8rem; color: #7c3aed;">üìÑ Importar PDF</h2>
                            <p style="color: var(--text-secondary); margin-top: 0.5rem;">Extrae art√≠culos autom√°ticamente</p>
                        </div>
                        <div style="font-size: 3rem;">ü•â</div>
                    </div>

                    <input type="file" id="proPdfInput" accept=".pdf" style="display: none;" onchange="handleProPDF(event)">
                    <div onclick="document.getElementById('proPdfInput').click()" style="border: 3px dashed var(--border-color); border-radius: 12px; padding: 2.5rem; text-align: center; cursor: pointer; background: var(--bg-primary); transition: all 0.3s;" onmouseover="this.style.borderColor='#7c3aed'" onmouseout="this.style.borderColor='var(--border-color)'">
                        <div style="font-size: 4rem; margin-bottom: 0.75rem;">üì§</div>
                        <div style="font-size: 1.2rem; font-weight: 700; margin-bottom: 0.3rem;">Subir PDF de Ley</div>
                        <div style="color: var(--text-secondary); font-size: 0.9rem;">C√≥digo Civil, Penal, etc.</div>
                    </div>
                    <div id="proPdfResult" style="margin-top: 1rem;"></div>
                </div>

                <!-- MEJORA #4: CASOS -->
                <div class="tracker-card" style="border-left-color: #059669;">
                    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem; margin-bottom: 1.5rem;">
                        <div style="flex: 1; min-width: 250px;">
                            <h2 style="font-family: 'Crimson Pro', serif; font-size: 1.8rem; color: #059669;">üíº Casos Pr√°cticos IA</h2>
                            <p style="color: var(--text-secondary); margin-top: 0.5rem;">Genera casos reales</p>
                        </div>
                        <div style="font-size: 3rem;">üèÖ</div>
                    </div>

                    <input type="text" id="proCaseInput" placeholder="Ej: C√≥digo Civil Art. 1255" style="width: 100%; padding: 1rem; border: 2px solid var(--border-color); border-radius: 12px; margin-bottom: 1rem; font-size: 1rem;">
                    <button class="btn" onclick="generateProCase()" style="width: 100%; background: #059669; padding: 1rem;">ü§ñ Generar Caso</button>
                    <div id="proCaseOutput" style="margin-top: 1rem;"></div>
                </div>

                <!-- MEJORA #5: ASISTENTE -->
                <div class="tracker-card" style="border-left-color: #ec4899;">
                    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem; margin-bottom: 1.5rem;">
                        <div style="flex: 1; min-width: 250px;">
                            <h2 style="font-family: 'Crimson Pro', serif; font-size: 1.8rem; color: #ec4899;">ü§ñ Asistente IA</h2>
                            <p style="color: var(--text-secondary); margin-top: 0.5rem;">Tu tutor personal 24/7</p>
                        </div>
                        <div style="font-size: 3rem;">üèÖ</div>
                    </div>

                    <div id="proAIChatContainer" style="background: var(--bg-primary); border-radius: 12px; padding: 1.5rem; min-height: 350px; max-height: 500px; overflow-y: auto; margin-bottom: 1rem;">
                        <div style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                            <div style="font-size: 3rem; margin-bottom: 0.75rem;">ü§ñ</div>
                            <div style="font-size: 1.1rem; font-weight: 700; margin-bottom: 0.3rem;">Asistente IA Listo</div>
                            <div style="font-size: 0.95rem;">Preg√∫ntame lo que quieras</div>
                        </div>
                    </div>

                    <div style="display: flex; gap: 0.5rem; margin-bottom: 0.75rem; flex-wrap: wrap;">
                        <button class="btn secondary" onclick="proQuickAI('Expl√≠came como si tuviera 5 a√±os')" style="font-size: 0.8rem; padding: 0.4rem 0.8rem;">üßí Simple</button>
                        <button class="btn secondary" onclick="proQuickAI('Dame un ejemplo pr√°ctico')" style="font-size: 0.8rem; padding: 0.4rem 0.8rem;">üíº Ejemplo</button>
                        <button class="btn secondary" onclick="proQuickAI('Crea una mnemotecnia')" style="font-size: 0.8rem; padding: 0.4rem 0.8rem;">üß† Mnemotecnia</button>
                    </div>

                    <div style="display: flex; gap: 0.5rem;">
                        <input type="text" id="proAIChatInput" placeholder="Pregunta aqu√≠..." style="flex: 1; padding: 1rem; border: 2px solid var(--border-color); border-radius: 12px; font-size: 1rem;" onkeypress="if(event.key==='Enter') sendProAI()">
                        <button class="btn" onclick="sendProAI()" style="padding: 1rem 1.5rem; background: #ec4899;">üì§</button>
                    </div>
                </div>

            </div>
        </div>

    </div>

    <script>
        async function compareTexts() {
            const originalText = document.getElementById('originalText').value.trim();
            const recallText = document.getElementById('recallText').value.trim();
            const articleNumber = document.getElementById('articleNumber').value.trim();
            const articleSection = document.getElementById('articleSection').value.trim();
            const tags = document.getElementById('articleTags').value.trim();
            
            if (!originalText || !recallText) {
                alert('Por favor, completa tanto el art√≠culo original como tu recuerdo antes de comparar.');
                return;
            }
            
            if (!articleNumber) {
                alert('Por favor, identifica el art√≠culo que est√°s estudiando (ej: C√≥digo Civil Art. 1255)');
                return;
            }

            const compareBtn = document.getElementById('compareBtn');
            compareBtn.disabled = true;
            compareBtn.innerHTML = '<div class="spinner"></div> Analizando...';

            try {
                // Comparaci√≥n visual palabra por palabra
                performVisualComparison(originalText, recallText);
                
                // Comparaci√≥n con IA
                await analyzeComparison(originalText, recallText, articleNumber, articleSection, tags);
                
                // Puntos de repaso
                await generateReviewPoints(originalText, recallText);
                
                // Tarjetas de estudio
                await generateStudyCards(originalText, recallText, articleNumber, articleSection, tags);
                
                compareBtn.innerHTML = '‚úÖ An√°lisis Completado';
                compareBtn.disabled = false;
                
                // Actualizar sugerencias de etiquetas
                updateTagSuggestions(tags);
                
                // Limpiar campos para el siguiente apartado
                setTimeout(() => {
                    if (confirm('¬øQuieres limpiar los campos para estudiar el siguiente apartado del art√≠culo?')) {
                        document.getElementById('originalText').value = '';
                        document.getElementById('recallText').value = '';
                        document.getElementById('articleSection').value = '';
                        document.getElementById('comparisonResult').innerHTML = '<em style="color: var(--text-secondary);">Completa los pasos 1 y 2, luego haz clic en "Comparar y Analizar"</em>';
                        document.getElementById('reviewPoints').innerHTML = '<em style="color: var(--text-secondary);">Los puntos clave para repasar aparecer√°n autom√°ticamente</em>';
                        document.getElementById('studyCards').innerHTML = '<em style="color: var(--text-secondary);">Las tarjetas de estudio se generar√°n autom√°ticamente</em>';
                        document.getElementById('visualComparison').style.display = 'none';
                        compareBtn.innerHTML = 'üîç Comparar y Analizar';
                        
                        // Scroll al inicio
                        window.scrollTo({ top: 0, behavior: 'smooth' });
                    }
                }, 1000);
                
            } catch (error) {
                console.error('Error:', error);
                compareBtn.innerHTML = 'üîç Comparar y Analizar';
                compareBtn.disabled = false;
                
                // Ofrecer modo offline
                if (confirm('Error al conectar con la IA. ¬øQuieres usar el modo de an√°lisis b√°sico offline?')) {
                    performOfflineAnalysis(originalText, recallText, articleNumber, articleSection);
                } else {
                    alert('Hubo un error al analizar. Por favor, verifica tu conexi√≥n e intenta de nuevo.');
                }
            }
        }

        // Comparaci√≥n visual palabra por palabra
        function performVisualComparison(original, recall) {
            const visualDiv = document.getElementById('visualComparison');
            visualDiv.style.display = 'block';
            
            const originalWords = original.toLowerCase().split(/\s+/);
            const recallWords = recall.toLowerCase().split(/\s+/);
            
            const originalSet = new Set(originalWords);
            const recallSet = new Set(recallWords);
            
            // Calcular similitud
            const intersection = new Set([...originalSet].filter(x => recallSet.has(x)));
            const similarity = Math.round((intersection.size / originalSet.size) * 100);
            
            const similarityBadge = document.getElementById('similarityBadge');
            similarityBadge.style.display = 'inline-block';
            similarityBadge.textContent = `${similarity}% similitud`;
            
            if (similarity >= 80) {
                similarityBadge.style.background = '#059669';
            } else if (similarity >= 60) {
                similarityBadge.style.background = '#f59e0b';
            } else {
                similarityBadge.style.background = '#dc2626';
            }
            
            // Resaltar palabras en original
            const originalHighlighted = original.split(/\s+/).map(word => {
                const cleanWord = word.toLowerCase().replace(/[.,;:!?]/g, '');
                if (recallSet.has(cleanWord)) {
                    return `<span class="highlight-match">${word}</span>`;
                } else {
                    return `<span class="highlight-missing">${word}</span>`;
                }
            }).join(' ');
            
            // Resaltar palabras en recuerdo
            const recallHighlighted = recall.split(/\s+/).map(word => {
                const cleanWord = word.toLowerCase().replace(/[.,;:!?]/g, '');
                if (originalSet.has(cleanWord)) {
                    return `<span class="highlight-match">${word}</span>`;
                } else {
                    return `<span class="highlight-extra">${word}</span>`;
                }
            }).join(' ');
            
            document.getElementById('originalHighlighted').innerHTML = originalHighlighted;
            document.getElementById('recallHighlighted').innerHTML = recallHighlighted;
        }

        // Funci√≥n para hacer llamadas API con reintentos
        async function fetchWithRetry(url, options, maxRetries = 3) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url, options);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    return await response.json();
                } catch (error) {
                    console.error(`Intento ${i + 1} fallido:`, error);
                    
                    if (i === maxRetries - 1) {
                        throw error;
                    }
                    
                    // Esperar antes de reintentar (exponential backoff)
                    await new Promise(resolve => setTimeout(resolve, Math.pow(2, i) * 1000));
                }
            }
        }

        // Modo offline - an√°lisis b√°sico sin IA
        function performOfflineAnalysis(original, recall, articleNumber, articleSection) {
            const section3 = document.getElementById('section3');
            const section4 = document.getElementById('section4');
            const section5 = document.getElementById('section5');
            
            section3.classList.remove('disabled');
            section4.classList.remove('disabled');
            section5.classList.remove('disabled');
            
            // An√°lisis b√°sico de similitud
            const originalWords = new Set(original.toLowerCase().split(/\s+/).filter(w => w.length > 3));
            const recallWords = new Set(recall.toLowerCase().split(/\s+/).filter(w => w.length > 3));
            
            const matches = [...originalWords].filter(word => recallWords.has(word));
            const omissions = [...originalWords].filter(word => !recallWords.has(word));
            
            // Mostrar resultados b√°sicos
            document.getElementById('comparisonResult').innerHTML = `
                <div class="tip" style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border-left-color: #f59e0b;">
                    ‚ö†Ô∏è An√°lisis offline b√°sico (sin IA). Reconecta para an√°lisis completo.
                </div>
                <div class="comparison-item match">
                    <div class="comparison-label">‚úÖ Palabras clave recordadas</div>
                    <p>Aproximadamente ${matches.length} palabras clave correctas</p>
                </div>
                <div class="comparison-item missing">
                    <div class="comparison-label">‚ùå Conceptos posiblemente omitidos</div>
                    <p>Detectadas ${omissions.length} palabras clave del original no mencionadas</p>
                </div>
            `;
            
            document.getElementById('reviewPoints').innerHTML = `
                <div style="line-height: 1.8;">
                    <p><strong>Modo offline:</strong> Revisa manualmente el art√≠culo original y compara con tu recuerdo.</p>
                    <p>Palabras que podr√≠as haber olvidado: ${omissions.slice(0, 10).join(', ')}...</p>
                </div>
            `;
            
            document.getElementById('studyCards').innerHTML = `
                <div class="tip">
                    üîå El modo offline no puede generar tarjetas de estudio. Reconecta para usar IA.
                </div>
            `;
            
            // Guardar datos b√°sicos
            const articleIdentifier = articleSection ? `${articleNumber} - ${articleSection}` : articleNumber;
            
            saveErrorsToHistory(
                omissions.slice(0, 5).map(w => `Posible omisi√≥n de concepto relacionado con: ${w}`),
                [],
                original,
                articleNumber,
                articleSection
            );
            
            saveSessionStats(original, recall, [], omissions.slice(0, 5), articleNumber, articleSection);
        }

        async function analyzeComparison(original, recall, articleNumber, articleSection, tags) {
            const section = document.getElementById('section3');
            const resultDiv = document.getElementById('comparisonResult');
            
            section.classList.remove('disabled');
            resultDiv.innerHTML = '<div class="loading"><div class="spinner"></div>Analizando las coincidencias y diferencias...</div>';

            const data = await fetchWithRetry("https://api.anthropic.com/v1/messages", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({
                    model: "claude-sonnet-4-20250514",
                    max_tokens: 1000,
                    messages: [{
                        role: "user",
                        content: `Compara estos dos textos y proporciona un an√°lisis estructurado:

TEXTO ORIGINAL:
${original}

RECUERDO DEL ESTUDIANTE:
${recall}

Por favor, analiza:
1. COINCIDENCIAS: Conceptos que record√≥ correctamente
2. OMISIONES: Informaci√≥n importante que falt√≥
3. ERRORES: Informaci√≥n incorrecta o malinterpretada

Responde en formato JSON:
{
  "matches": ["concepto 1", "concepto 2"],
  "omissions": ["concepto olvidado 1", "concepto olvidado 2"],
  "errors": ["error 1", "error 2"]
}`
                    }]
                })
            });

            const content = data.content[0].text;
            
            // Extraer JSON del contenido
            const jsonMatch = content.match(/\{[\s\S]*\}/);
            if (jsonMatch) {
                const analysis = JSON.parse(jsonMatch[0]);
                displayComparison(analysis);
                
                // Acumular errores y omisiones en localStorage con identificaci√≥n y etiquetas
                saveErrorsToHistory(analysis.omissions, analysis.errors, original, articleNumber, articleSection, tags);
                
                // Guardar estad√≠sticas de la sesi√≥n
                saveSessionStats(original, recall, analysis.errors, analysis.omissions, articleNumber, articleSection);
            } else {
                resultDiv.innerHTML = '<p>' + content + '</p>';
            }
        }

        function saveErrorsToHistory(omissions, errors, articleContext, articleNumber, articleSection, tags) {
            const errorHistory = JSON.parse(localStorage.getItem('errorHistory') || '[]');
            const timestamp = new Date().toLocaleString('es-ES', { 
                day: '2-digit', 
                month: '2-digit', 
                hour: '2-digit', 
                minute: '2-digit' 
            });
            
            const articleIdentifier = articleSection 
                ? `${articleNumber} - ${articleSection}`
                : articleNumber;
            
            const tagList = tags ? tags.split(',').map(t => t.trim()).filter(t => t) : [];
            
            const newErrors = [];
            
            if (omissions && omissions.length > 0) {
                omissions.forEach(omission => {
                    newErrors.push({
                        type: 'omission',
                        content: omission,
                        article: articleContext.substring(0, 100) + '...',
                        fullArticle: articleContext,
                        articleId: articleIdentifier,
                        tags: tagList,
                        timestamp: timestamp,
                        id: Date.now() + Math.random()
                    });
                });
            }
            
            if (errors && errors.length > 0) {
                errors.forEach(error => {
                    newErrors.push({
                        type: 'error',
                        content: error,
                        article: articleContext.substring(0, 100) + '...',
                        fullArticle: articleContext,
                        articleId: articleIdentifier,
                        tags: tagList,
                        timestamp: timestamp,
                        id: Date.now() + Math.random()
                    });
                });
            }
            
            errorHistory.push(...newErrors);
            localStorage.setItem('errorHistory', JSON.stringify(errorHistory));
            
            // Actualizar visualizaci√≥n
            displayErrorHistory();
        }

        function displayErrorHistory(page = 1) {
            const errorHistory = JSON.parse(localStorage.getItem('errorHistory') || '[]');
            const errorHistoryContent = document.getElementById('errorHistoryContent');
            const errorCount = document.getElementById('errorCount');
            const paginationDiv = document.getElementById('errorPagination');
            
            errorCount.textContent = `${errorHistory.length} errores`;
            
            if (errorHistory.length === 0) {
                errorHistoryContent.innerHTML = '<em style="color: var(--text-secondary);">A√∫n no hay errores acumulados. Completa tu primer an√°lisis para empezar.</em>';
                if (paginationDiv) paginationDiv.style.display = 'none';
                return;
            }
            
            const itemsPerPage = 20;
            const totalPages = Math.ceil(errorHistory.length / itemsPerPage);
            const start = (page - 1) * itemsPerPage;
            const end = start + itemsPerPage;
            const paginatedErrors = errorHistory.slice().reverse().slice(start, end);
            
            let html = '';
            paginatedErrors.forEach(error => {
                const icon = error.type === 'omission' ? '‚ùå' : '‚ö†Ô∏è';
                const typeLabel = error.type === 'omission' ? 'Omisi√≥n' : 'Error';
                
                html += `
                    <div class="error-item">
                        <div class="error-item-header">
                            <span class="error-item-title">${icon} ${typeLabel}</span>
                            <span class="error-item-time">${error.timestamp}</span>
                        </div>
                        ${error.articleId ? `<div style="margin-bottom: 0.5rem; font-weight: 600; color: var(--accent-primary); font-size: 0.9rem;">üìú ${error.articleId}</div>` : ''}
                        ${error.tags && error.tags.length > 0 ? `<div style="margin-bottom: 0.5rem;">${error.tags.map(tag => `<span class="tag-badge" style="font-size: 0.75rem; padding: 0.2rem 0.5rem;">${tag}</span>`).join(' ')}</div>` : ''}
                        <div class="error-item-content">
                            <strong>${error.content}</strong>
                        </div>
                        <div style="margin-top: 0.5rem; font-size: 0.85rem; color: var(--text-secondary);">
                            üìÑ Contexto: ${error.article}
                        </div>
                    </div>
                `;
            });
            
            errorHistoryContent.innerHTML = html;
            
            // Mostrar paginaci√≥n si hay m√°s de una p√°gina
            if (paginationDiv && totalPages > 1) {
                paginationDiv.style.display = 'flex';
                displayErrorPagination(page, totalPages);
            } else if (paginationDiv) {
                paginationDiv.style.display = 'none';
            }
        }

        function displayErrorPagination(currentPage, totalPages) {
            const paginationDiv = document.getElementById('errorPagination');
            if (!paginationDiv) return;
            
            let html = '';
            
            if (currentPage > 1) {
                html += `<button class="page-btn" onclick="displayErrorHistory(${currentPage - 1})">‚Üê Anterior</button>`;
            }
            
            for (let i = 1; i <= totalPages; i++) {
                if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
                    html += `<button class="page-btn ${i === currentPage ? 'active' : ''}" onclick="displayErrorHistory(${i})">${i}</button>`;
                } else if (i === currentPage - 3 || i === currentPage + 3) {
                    html += `<span style="padding: 0.5rem;">...</span>`;
                }
            }
            
            if (currentPage < totalPages) {
                html += `<button class="page-btn" onclick="displayErrorHistory(${currentPage + 1})">Siguiente ‚Üí</button>`;
            }
            
            paginationDiv.innerHTML = html;
        }

        function displayComparison(analysis) {
            const resultDiv = document.getElementById('comparisonResult');
            let html = '';

            if (analysis.matches && analysis.matches.length > 0) {
                html += '<div class="comparison-item match"><div class="comparison-label">‚úÖ Conceptos Correctos</div>';
                analysis.matches.forEach(item => {
                    html += `<p>‚Ä¢ ${item}</p>`;
                });
                html += '</div>';
            }

            if (analysis.omissions && analysis.omissions.length > 0) {
                html += '<div class="comparison-item missing"><div class="comparison-label">‚ùå Omisiones</div>';
                analysis.omissions.forEach(item => {
                    html += `<p>‚Ä¢ ${item}</p>`;
                });
                html += '</div>';
            }

            if (analysis.errors && analysis.errors.length > 0) {
                html += '<div class="comparison-item extra"><div class="comparison-label">‚ö†Ô∏è Errores o Imprecisiones</div>';
                analysis.errors.forEach(item => {
                    html += `<p>‚Ä¢ ${item}</p>`;
                });
                html += '</div>';
            }

            resultDiv.innerHTML = html;
        }

        async function generateReviewPoints(original, recall) {
            const section = document.getElementById('section4');
            const resultDiv = document.getElementById('reviewPoints');
            
            section.classList.remove('disabled');
            resultDiv.innerHTML = '<div class="loading"><div class="spinner"></div>Identificando puntos clave para repasar...</div>';

            const data = await fetchWithRetry("https://api.anthropic.com/v1/messages", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({
                    model: "claude-sonnet-4-20250514",
                    max_tokens: 1000,
                    messages: [{
                        role: "user",
                        content: `Bas√°ndote en esta comparaci√≥n, identifica los 3-5 puntos m√°s importantes que el estudiante debe repasar:

TEXTO ORIGINAL:
${original}

RECUERDO DEL ESTUDIANTE:
${recall}

Crea una lista clara y concisa de los conceptos que necesitan m√°s atenci√≥n. Responde solo con la lista, sin introducci√≥n.`
                    }]
                })
            });

            const content = data.content[0].text;
            
            resultDiv.innerHTML = `<div style="line-height: 1.8;">${content.replace(/\n/g, '<br>')}</div>`;
        }

        async function generateStudyCards(original, recall, articleNumber, articleSection, tags) {
            const section = document.getElementById('section5');
            const cardsDiv = document.getElementById('studyCards');
            
            section.classList.remove('disabled');
            cardsDiv.innerHTML = '<div class="loading"><div class="spinner"></div>Creando tarjetas de estudio personalizadas...</div>';

            const data = await fetchWithRetry("https://api.anthropic.com/v1/messages", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({
                    model: "claude-sonnet-4-20250514",
                    max_tokens: 1000,
                    messages: [{
                        role: "user",
                        content: `Crea 3-5 tarjetas de estudio en formato pregunta-respuesta basadas en los conceptos que el estudiante olvid√≥ o confundi√≥:

TEXTO ORIGINAL:
${original}

RECUERDO DEL ESTUDIANTE:
${recall}

Responde SOLO en formato JSON:
{
  "cards": [
    {"question": "pregunta 1", "answer": "respuesta 1"},
    {"question": "pregunta 2", "answer": "respuesta 2"}
  ]
}`
                    }]
                })
            });

            const content = data.content[0].text;
            
            const jsonMatch = content.match(/\{[\s\S]*\}/);
            if (jsonMatch) {
                const cards = JSON.parse(jsonMatch[0]);
                displayStudyCards(cards.cards, articleNumber, articleSection, tags);
            } else {
                cardsDiv.innerHTML = '<p>' + content + '</p>';
            }
        }

        function displayStudyCards(cards, articleNumber, articleSection, tags) {
            const cardsDiv = document.getElementById('studyCards');
            let html = '';

            cards.forEach((card, index) => {
                html += `
                    <div class="study-card">
                        <div class="study-card-question">P${index + 1}: ${card.question}</div>
                        <div class="study-card-answer">${card.answer}</div>
                    </div>
                `;
            });

            cardsDiv.innerHTML = html;
            
            // Acumular tarjetas en localStorage
            saveCardsToCollection(cards, articleNumber, articleSection, tags);
        }

        function saveCardsToCollection(newCards, articleNumber, articleSection, tags) {
            const cardCollection = JSON.parse(localStorage.getItem('cardCollection') || '[]');
            const timestamp = new Date().toLocaleString('es-ES', { 
                day: '2-digit', 
                month: '2-digit', 
                hour: '2-digit', 
                minute: '2-digit' 
            });
            
            const articleIdentifier = articleSection 
                ? `${articleNumber} - ${articleSection}`
                : articleNumber;
            
            const tagList = tags ? tags.split(',').map(t => t.trim()).filter(t => t) : [];
            
            newCards.forEach(card => {
                cardCollection.push({
                    question: card.question,
                    answer: card.answer,
                    articleId: articleIdentifier,
                    tags: tagList,
                    difficulty: 0,
                    timestamp: timestamp,
                    id: Date.now() + Math.random()
                });
            });
            
            localStorage.setItem('cardCollection', JSON.stringify(cardCollection));
            
            // Actualizar visualizaci√≥n
            displayCardCollection();
        }

        function clearHistory() {
            if (confirm('¬øEst√°s seguro de que quieres limpiar todo el historial de errores?')) {
                localStorage.removeItem('errorHistory');
                displayErrorHistory();
            }
        }

        function clearCards() {
            if (confirm('¬øEst√°s seguro de que quieres eliminar todas las tarjetas de estudio?')) {
                localStorage.removeItem('cardCollection');
                displayCardCollection();
            }
        }

        let currentFilter = 'all';

        function filterByType(type) {
            currentFilter = type;
            
            // Actualizar botones activos
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-filter="${type}"]`).classList.add('active');
            
            // Aplicar filtro
            filterErrors();
        }

        function filterErrors() {
            const searchTerm = document.getElementById('searchErrors').value.toLowerCase();
            const errorHistory = JSON.parse(localStorage.getItem('errorHistory') || '[]');
            
            let filtered = errorHistory;
            
            // Filtrar por tipo
            if (currentFilter !== 'all') {
                filtered = filtered.filter(error => error.type === currentFilter);
            }
            
            // Filtrar por b√∫squeda
            if (searchTerm) {
                filtered = filtered.filter(error => 
                    error.content.toLowerCase().includes(searchTerm) ||
                    error.article.toLowerCase().includes(searchTerm)
                );
            }
            
            displayFilteredErrors(filtered);
        }

        function displayFilteredErrors(errors) {
            const errorHistoryContent = document.getElementById('errorHistoryContent');
            const errorCount = document.getElementById('errorCount');
            
            errorCount.textContent = `${errors.length} errores`;
            
            if (errors.length === 0) {
                errorHistoryContent.innerHTML = '<em style="color: var(--text-secondary);">No se encontraron errores con los criterios de b√∫squeda.</em>';
                return;
            }
            
            let html = '';
            errors.reverse().forEach(error => {
                const icon = error.type === 'omission' ? '‚ùå' : '‚ö†Ô∏è';
                const typeLabel = error.type === 'omission' ? 'Omisi√≥n' : 'Error';
                
                html += `
                    <div class="error-item">
                        <div class="error-item-header">
                            <span class="error-item-title">${icon} ${typeLabel}</span>
                            <span class="error-item-time">${error.timestamp}</span>
                        </div>
                        ${error.articleId ? `<div style="margin-bottom: 0.5rem; font-weight: 600; color: var(--accent-primary); font-size: 0.9rem;">üìú ${error.articleId}</div>` : ''}
                        <div class="error-item-content">
                            <strong>${error.content}</strong>
                        </div>
                        <div style="margin-top: 0.5rem; font-size: 0.85rem; color: var(--text-secondary);">
                            üìÑ Contexto: ${error.article}
                        </div>
                    </div>
                `;
            });
            
            errorHistoryContent.innerHTML = html;
        }

        function filterCards() {
            const searchTerm = document.getElementById('searchCards').value.toLowerCase();
            const cardCollection = JSON.parse(localStorage.getItem('cardCollection') || '[]');
            
            const filtered = cardCollection.filter(card => 
                card.question.toLowerCase().includes(searchTerm) ||
                card.answer.toLowerCase().includes(searchTerm) ||
                (card.articleId && card.articleId.toLowerCase().includes(searchTerm))
            );
            
            displayFilteredCards(filtered);
        }

        function displayFilteredCards(cards) {
            const cardCollectionContent = document.getElementById('cardCollectionContent');
            const cardCount = document.getElementById('cardCount');
            
            cardCount.textContent = `${cards.length} tarjetas`;
            
            if (cards.length === 0) {
                cardCollectionContent.innerHTML = '<em style="color: var(--text-secondary);">No se encontraron tarjetas con los criterios de b√∫squeda.</em>';
                return;
            }
            
            let html = '';
            cards.reverse().forEach((card, index) => {
                html += `
                    <div class="card-item">
                        <div class="card-item-header">
                            <span class="card-item-number">Tarjeta #${cards.length - index}</span>
                            <span class="card-item-time">${card.timestamp}</span>
                        </div>
                        ${card.articleId ? `<div style="margin-bottom: 0.75rem; font-weight: 600; color: var(--accent-tertiary); font-size: 0.9rem;">üìú ${card.articleId}</div>` : ''}
                        <div class="card-item-question">${card.question}</div>
                        <div class="card-item-answer">${card.answer}</div>
                    </div>
                `;
            });
            
            cardCollectionContent.innerHTML = html;
        }

        function exportToPDF() {
            const errorHistory = JSON.parse(localStorage.getItem('errorHistory') || '[]');
            
            if (errorHistory.length === 0) {
                alert('No hay errores para exportar.');
                return;
            }
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // T√≠tulo
            doc.setFontSize(20);
            doc.setFont(undefined, 'bold');
            doc.text('Historial de Errores - Estudio de Leyes', 20, 20);
            
            // Fecha
            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            doc.text(`Generado: ${new Date().toLocaleString('es-ES')}`, 20, 28);
            
            // Estad√≠sticas
            const omissions = errorHistory.filter(e => e.type === 'omission').length;
            const errors = errorHistory.filter(e => e.type === 'error').length;
            doc.text(`Total de errores: ${errorHistory.length} (${omissions} omisiones, ${errors} errores)`, 20, 35);
            
            // Agrupar por art√≠culo
            const byArticle = {};
            errorHistory.forEach(error => {
                const key = error.articleId || 'Sin identificar';
                if (!byArticle[key]) byArticle[key] = [];
                byArticle[key].push(error);
            });
            
            doc.setFontSize(9);
            doc.text(`Articulos estudiados: ${Object.keys(byArticle).length}`, 20, 42);
            
            let yPos = 52;
            const pageHeight = doc.internal.pageSize.height;
            const margin = 20;
            const lineHeight = 7;
            
            Object.keys(byArticle).forEach(articleId => {
                const articleErrors = byArticle[articleId];
                
                // Verificar si necesitamos una nueva p√°gina
                if (yPos > pageHeight - 50) {
                    doc.addPage();
                    yPos = 20;
                }
                
                // T√≠tulo del art√≠culo
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                doc.setTextColor(217, 119, 6);
                doc.text(`${articleId}`, margin, yPos);
                doc.setTextColor(0);
                yPos += lineHeight + 3;
                
                articleErrors.forEach((error, index) => {
                    // Verificar si necesitamos una nueva p√°gina
                    if (yPos > pageHeight - 40) {
                        doc.addPage();
                        yPos = 20;
                    }
                    
                    // Tipo y fecha
                    doc.setFontSize(9);
                    doc.setFont(undefined, 'bold');
                    const typeText = error.type === 'omission' ? 'OMISION' : 'ERROR';
                    doc.text(`${typeText} - ${error.timestamp}`, margin + 5, yPos);
                    yPos += lineHeight;
                    
                    // Contenido del error
                    doc.setFont(undefined, 'normal');
                    doc.setFontSize(9);
                    const contentLines = doc.splitTextToSize(error.content, 165);
                    doc.text(contentLines, margin + 5, yPos);
                    yPos += contentLines.length * lineHeight + 5;
                });
                
                yPos += 5;
            });
            
            doc.save(`errores_estudio_${new Date().toISOString().split('T')[0]}.pdf`);
        }

        function exportCardsToPDF() {
            const cardCollection = JSON.parse(localStorage.getItem('cardCollection') || '[]');
            
            if (cardCollection.length === 0) {
                alert('No hay tarjetas para exportar.');
                return;
            }
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // T√≠tulo
            doc.setFontSize(20);
            doc.setFont(undefined, 'bold');
            doc.text('Tarjetas de Estudio - Leyes', 20, 20);
            
            // Fecha
            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            doc.text(`Generado: ${new Date().toLocaleString('es-ES')}`, 20, 28);
            doc.text(`Total de tarjetas: ${cardCollection.length}`, 20, 35);
            
            // Agrupar por art√≠culo
            const byArticle = {};
            cardCollection.forEach(card => {
                const key = card.articleId || 'Sin identificar';
                if (!byArticle[key]) byArticle[key] = [];
                byArticle[key].push(card);
            });
            
            let yPos = 45;
            const pageHeight = doc.internal.pageSize.height;
            const margin = 20;
            const lineHeight = 7;
            
            Object.keys(byArticle).forEach(articleId => {
                const articleCards = byArticle[articleId];
                
                // Verificar si necesitamos una nueva p√°gina
                if (yPos > pageHeight - 50) {
                    doc.addPage();
                    yPos = 20;
                }
                
                // T√≠tulo del art√≠culo
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                doc.setTextColor(5, 150, 105);
                doc.text(`${articleId}`, margin, yPos);
                doc.setTextColor(0);
                yPos += lineHeight + 3;
                
                articleCards.forEach((card, index) => {
                    // Verificar si necesitamos una nueva p√°gina
                    if (yPos > pageHeight - 50) {
                        doc.addPage();
                        yPos = 20;
                    }
                    
                    // N√∫mero y fecha
                    doc.setFontSize(9);
                    doc.setFont(undefined, 'bold');
                    doc.text(`Tarjeta ${index + 1}`, margin + 5, yPos);
                    yPos += lineHeight;
                    
                    // Pregunta
                    doc.setFontSize(10);
                    doc.setTextColor(217, 119, 6);
                    doc.text('P:', margin + 5, yPos);
                    doc.setTextColor(0);
                    doc.setFont(undefined, 'bold');
                    const questionLines = doc.splitTextToSize(card.question, 160);
                    doc.text(questionLines, margin + 12, yPos);
                    yPos += questionLines.length * lineHeight + 2;
                    
                    // Respuesta
                    doc.setFontSize(9);
                    doc.setTextColor(100);
                    doc.setFont(undefined, 'normal');
                    doc.text('R:', margin + 5, yPos);
                    doc.setTextColor(0);
                    const answerLines = doc.splitTextToSize(card.answer, 160);
                    doc.text(answerLines, margin + 12, yPos);
                    yPos += answerLines.length * lineHeight + 5;
                    
                    // L√≠nea separadora
                    doc.setDrawColor(220);
                    doc.line(margin + 5, yPos, 190, yPos);
                    yPos += 8;
                });
                
                yPos += 5;
            });
            
            doc.save(`tarjetas_estudio_${new Date().toISOString().split('T')[0]}.pdf`);
        }

        // Exportar errores a JSON
        function exportToJSON() {
            const errorHistory = JSON.parse(localStorage.getItem('errorHistory') || '[]');
            const studyStats = JSON.parse(localStorage.getItem('studyStats') || '{"sessions": []}');
            
            const data = {
                version: "1.0",
                exportDate: new Date().toISOString(),
                errorHistory: errorHistory,
                studyStats: studyStats
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `errores_backup_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // Importar desde JSON
        function importFromJSON() {
            document.getElementById('fileImport').click();
        }

        function handleFileImport(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    if (!data.errorHistory || !data.studyStats) {
                        alert('Archivo JSON no v√°lido');
                        return;
                    }
                    
                    if (confirm('¬øQuieres REEMPLAZAR tus datos actuales o COMBINARLOS con los importados?')) {
                        // Combinar
                        const currentErrors = JSON.parse(localStorage.getItem('errorHistory') || '[]');
                        const currentStats = JSON.parse(localStorage.getItem('studyStats') || '{"sessions": []}');
                        
                        localStorage.setItem('errorHistory', JSON.stringify([...currentErrors, ...data.errorHistory]));
                        localStorage.setItem('studyStats', JSON.stringify({
                            sessions: [...currentStats.sessions, ...data.studyStats.sessions]
                        }));
                    } else {
                        // Reemplazar
                        localStorage.setItem('errorHistory', JSON.stringify(data.errorHistory));
                        localStorage.setItem('studyStats', JSON.stringify(data.studyStats));
                    }
                    
                    displayErrorHistory();
                    updateStatistics();
                    updateAdvancedStats();
                    alert('Datos importados correctamente');
                    
                } catch (error) {
                    console.error('Error al importar:', error);
                    alert('Error al importar el archivo. Verifica que sea un JSON v√°lido.');
                }
            };
            reader.readAsText(file);
        }

        // Exportar tarjetas a JSON
        function exportCardsToJSON() {
            const cardCollection = JSON.parse(localStorage.getItem('cardCollection') || '[]');
            
            const data = {
                version: "1.0",
                exportDate: new Date().toISOString(),
                cards: cardCollection
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `tarjetas_backup_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // Exportar tarjetas para Anki (formato CSV)
        function exportCardsToAnki() {
            const cardCollection = JSON.parse(localStorage.getItem('cardCollection') || '[]');
            
            if (cardCollection.length === 0) {
                alert('No hay tarjetas para exportar.');
                return;
            }
            
            // Formato Anki: Pregunta;Respuesta;Tags
            let csv = '';
            cardCollection.forEach(card => {
                const question = card.question.replace(/"/g, '""').replace(/;/g, ',');
                const answer = card.answer.replace(/"/g, '""').replace(/;/g, ',');
                const tag = card.articleId ? card.articleId.replace(/\s/g, '_') : 'ley';
                csv += `"${question}";"${answer}";"${tag}"\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `anki_tarjetas_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            URL.revokeObjectURL(url);
            
            alert('Tarjetas exportadas para Anki. Importa el archivo CSV en Anki con el delimitador ";"');
        }

        // Cargar datos al iniciar la p√°gina
        window.addEventListener('DOMContentLoaded', () => {
            displayErrorHistory();
            displayCardCollection();
            updateStatistics();
            updateAdvancedStats();
            displayTagSuggestions();
            loadDarkModePreference();
            startAutoBackup();
            checkForDuplicates();
        });

        // Modo oscuro
        function toggleDarkMode() {
            const body = document.body;
            body.classList.toggle('dark-mode');
            const isDark = body.classList.contains('dark-mode');
            localStorage.setItem('darkMode', isDark);
            document.getElementById('darkModeToggle').textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
        }

        function loadDarkModePreference() {
            const isDark = localStorage.getItem('darkMode') === 'true';
            if (isDark) {
                document.body.classList.add('dark-mode');
                document.getElementById('darkModeToggle').textContent = '‚òÄÔ∏è';
            }
        }

        // Temporizador Pomodoro
        let pomodoroInterval = null;
        let pomodoroSeconds = 25 * 60; // 25 minutos
        let isPomodoro = true; // true = enfoque, false = descanso
        let isPomodoroRunning = false;

        function togglePomodoro() {
            if (isPomodoroRunning) {
                pausePomodoro();
            } else {
                startPomodoroTimer();
            }
        }

        function startPomodoroTimer() {
            isPomodoroRunning = true;
            document.getElementById('pomodoroBtn').innerHTML = '‚è∏ Pausar';
            
            pomodoroInterval = setInterval(() => {
                pomodoroSeconds--;
                
                const minutes = Math.floor(pomodoroSeconds / 60);
                const seconds = pomodoroSeconds % 60;
                document.getElementById('timerDisplay').textContent = 
                    `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                
                if (pomodoroSeconds <= 0) {
                    clearInterval(pomodoroInterval);
                    pomodoroComplete();
                }
            }, 1000);
        }

        function pausePomodoro() {
            clearInterval(pomodoroInterval);
            isPomodoroRunning = false;
            document.getElementById('pomodoroBtn').innerHTML = '‚ñ∂ Continuar';
        }

        function resetPomodoro() {
            clearInterval(pomodoroInterval);
            isPomodoroRunning = false;
            isPomodoro = true;
            pomodoroSeconds = 25 * 60;
            document.getElementById('timerDisplay').textContent = '25:00';
            document.getElementById('timerLabel').textContent = 'Enfoque';
            document.getElementById('pomodoroBtn').innerHTML = '‚ñ∂ Iniciar';
        }

        function pomodoroComplete() {
            // Notificaci√≥n
            if ('Notification' in window && Notification.permission === 'granted') {
                new Notification(isPomodoro ? '¬°Tiempo de descanso!' : '¬°Volvamos a estudiar!', {
                    body: isPomodoro ? 'T√≥mate 5 minutos de descanso' : 'Comienza tu siguiente sesi√≥n',
                    icon: 'üìö'
                });
            }
            
            // Alternar entre enfoque y descanso
            isPomodoro = !isPomodoro;
            pomodoroSeconds = isPomodoro ? 25 * 60 : 5 * 60;
            document.getElementById('timerLabel').textContent = isPomodoro ? 'Enfoque' : 'Descanso';
            
            alert(isPomodoro ? '¬°Descanso completado! Listo para otra sesi√≥n' : '¬°Sesi√≥n completada! T√≥mate 5 minutos');
            
            resetPomodoro();
        }

        // Solicitar permiso de notificaciones
        if ('Notification' in window && Notification.permission === 'default') {
            Notification.requestPermission();
        }

        // Auto-backup
        function startAutoBackup() {
            // Realizar backup cada 10 minutos
            setInterval(() => {
                const errorHistory = JSON.parse(localStorage.getItem('errorHistory') || '[]');
                const cardCollection = JSON.parse(localStorage.getItem('cardCollection') || '[]');
                const studyStats = JSON.parse(localStorage.getItem('studyStats') || '{"sessions": []}');
                
                const backup = {
                    version: "1.0",
                    timestamp: new Date().toISOString(),
                    errorHistory: errorHistory,
                    cardCollection: cardCollection,
                    studyStats: studyStats
                };
                
                localStorage.setItem('autoBackup', JSON.stringify(backup));
                console.log('‚úÖ Backup autom√°tico realizado:', new Date().toLocaleString());
            }, 10 * 60 * 1000); // 10 minutos
        }

        // Prevenir duplicados
        function checkForDuplicates() {
            const articleNumber = document.getElementById('articleNumber').value.trim();
            const articleSection = document.getElementById('articleSection').value.trim();
            
            if (!articleNumber) return;
            
            const studyStats = JSON.parse(localStorage.getItem('studyStats') || '{"sessions": []}');
            const today = new Date().toDateString();
            
            const studiedToday = studyStats.sessions.filter(session => {
                const sessionDate = new Date(session.date).toDateString();
                const articleId = articleSection ? `${articleNumber} - ${articleSection}` : articleNumber;
                return sessionDate === today && session.articleId === articleId;
            });
            
            if (studiedToday.length > 0) {
                const lastSession = studiedToday[studiedToday.length - 1];
                if (confirm(`‚ö†Ô∏è Ya estudiaste "${lastSession.articleId}" hoy con ${lastSession.accuracy}% de precisi√≥n.\n\n¬øQuieres continuar de todas formas?`)) {
                    return true;
                }
                return false;
            }
            return true;
        }

        // A√±adir verificaci√≥n en compareTexts
        const originalCompareTexts = compareTexts;
        compareTexts = async function() {
            if (!checkForDuplicates()) {
                return;
            }
            await originalCompareTexts();
        };

        function updateStatistics() {
            const studyStats = JSON.parse(localStorage.getItem('studyStats') || '{"sessions": [], "totalAccuracy": 0}');
            const errorHistory = JSON.parse(localStorage.getItem('errorHistory') || '[]');
            const cardCollection = JSON.parse(localStorage.getItem('cardCollection') || '[]');
            
            const statsPanel = document.getElementById('statsPanel');
            
            if (studyStats.sessions.length > 0) {
                statsPanel.style.display = 'block';
                
                // Contar apartados √∫nicos estudiados
                const uniqueArticles = new Set();
                studyStats.sessions.forEach(session => {
                    if (session.articleId) {
                        uniqueArticles.add(session.articleId);
                    }
                });
                
                document.getElementById('totalArticles').textContent = uniqueArticles.size || studyStats.sessions.length;
                document.getElementById('totalErrors').textContent = errorHistory.length;
                document.getElementById('totalCards').textContent = cardCollection.length;
                
                // Calcular precisi√≥n promedio
                const avgAccuracy = studyStats.sessions.reduce((acc, session) => acc + session.accuracy, 0) / studyStats.sessions.length;
                document.getElementById('avgAccuracy').textContent = Math.round(avgAccuracy) + '%';
            }
        }

        let evolutionChart = null;

        function updateAdvancedStats() {
            const studyStats = JSON.parse(localStorage.getItem('studyStats') || '{"sessions": []}');
            const errorHistory = JSON.parse(localStorage.getItem('errorHistory') || '[]');
            
            if (studyStats.sessions.length === 0) {
                return;
            }
            
            document.getElementById('advancedStats').style.display = 'block';
            
            // Gr√°fico de evoluci√≥n
            updateEvolutionChart(studyStats);
            
            // Errores m√°s frecuentes
            updateFrequentErrors(errorHistory);
            
            // Art√≠culos con m√°s dificultad
            updateDifficultArticles(studyStats, errorHistory);
        }

        function updateEvolutionChart(studyStats) {
            const ctx = document.getElementById('evolutionChart');
            
            if (!ctx) return;
            
            const sessions = studyStats.sessions.slice(-10); // √öltimas 10 sesiones
            const labels = sessions.map((s, i) => `S${i + 1}`);
            const data = sessions.map(s => s.accuracy);
            
            if (evolutionChart) {
                evolutionChart.destroy();
            }
            
            evolutionChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Precisi√≥n (%)',
                        data: data,
                        borderColor: '#d97706',
                        backgroundColor: 'rgba(217, 119, 6, 0.1)',
                        tension: 0.3,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        }
                    }
                }
            });
        }

        function updateFrequentErrors(errorHistory) {
            const errorCounts = {};
            
            errorHistory.forEach(error => {
                const key = error.content.substring(0, 50);
                errorCounts[key] = (errorCounts[key] || 0) + 1;
            });
            
            const sorted = Object.entries(errorCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);
            
            const html = sorted.map(([error, count]) => `
                <div class="error-frequency-item">
                    <span class="error-frequency-text">${error}...</span>
                    <span class="error-frequency-count">${count}x</span>
                </div>
            `).join('');
            
            document.getElementById('frequentErrors').innerHTML = html || '<p style="color: var(--text-secondary);">No hay suficientes datos a√∫n</p>';
        }

        function updateDifficultArticles(studyStats, errorHistory) {
            const articleDifficulty = {};
            
            // Calcular dificultad por art√≠culo
            errorHistory.forEach(error => {
                if (error.articleId) {
                    articleDifficulty[error.articleId] = (articleDifficulty[error.articleId] || 0) + 1;
                }
            });
            
            const sorted = Object.entries(articleDifficulty)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);
            
            const html = sorted.map(([article, count]) => `
                <div class="error-frequency-item">
                    <span class="error-frequency-text">${article}</span>
                    <span class="error-frequency-count">${count} errores</span>
                </div>
            `).join('');
            
            document.getElementById('difficultArticles').innerHTML = html || '<p style="color: var(--text-secondary);">No hay suficientes datos a√∫n</p>';
        }

        // Sistema de Quiz y Repetici√≥n Espaciada
        let quizQueue = [];
        let currentQuizCard = null;
        let quizStats = { hard: 0, medium: 0, easy: 0, mastered: 0 };

        function startQuiz(filterTag = null) {
            let cardCollection = JSON.parse(localStorage.getItem('cardCollection') || '[]');
            
            // Filtrar tarjetas dominadas
            cardCollection = cardCollection.filter(card => !card.mastered);
            
            if (filterTag) {
                cardCollection = cardCollection.filter(card => 
                    card.tags && card.tags.includes(filterTag)
                );
            }
            
            if (cardCollection.length === 0) {
                alert('No hay tarjetas disponibles para repasar. ¬°Crea algunas primero!');
                return;
            }
            
            // Implementar repetici√≥n espaciada: priorizar tarjetas dif√≠ciles
            quizQueue = cardCollection.sort((a, b) => {
                const diffA = a.difficulty || 0;
                const diffB = b.difficulty || 0;
                return diffB - diffA;
            });
            
            quizStats = { hard: 0, medium: 0, easy: 0, mastered: 0 };
            
            document.getElementById('reviewMode').style.display = 'block';
            document.getElementById('quizStart').style.display = 'none';
            document.getElementById('quizCard').style.display = 'block';
            document.getElementById('quizSummary').style.display = 'none';
            
            showNextCard();
        }

        function showNextCard() {
            if (quizQueue.length === 0) {
                showQuizSummary();
                return;
            }
            
            currentQuizCard = quizQueue.shift();
            
            document.getElementById('quizArticle').textContent = currentQuizCard.articleId || 'Art√≠culo sin especificar';
            document.getElementById('quizCounter').textContent = `${quizStats.hard + quizStats.medium + quizStats.easy + quizStats.mastered + 1} / ${quizStats.hard + quizStats.medium + quizStats.easy + quizStats.mastered + quizQueue.length + 1}`;
            document.getElementById('quizQuestion').textContent = currentQuizCard.question;
            document.getElementById('quizAnswer').style.display = 'none';
            document.getElementById('showAnswerBtn').style.display = 'inline-flex';
            document.getElementById('difficultyButtons').style.display = 'none';
            
            document.getElementById('reviewProgress').textContent = `${quizQueue.length} restantes`;
        }

        function showQuizAnswer() {
            document.getElementById('quizAnswer').style.display = 'block';
            document.getElementById('quizAnswerText').textContent = currentQuizCard.answer;
            document.getElementById('showAnswerBtn').style.display = 'none';
            document.getElementById('difficultyButtons').style.display = 'flex';
        }

        function rateCard(difficulty) {
            quizStats[difficulty]++;
            
            // Actualizar dificultad de la tarjeta en localStorage
            const cardCollection = JSON.parse(localStorage.getItem('cardCollection') || '[]');
            const cardIndex = cardCollection.findIndex(c => c.id === currentQuizCard.id);
            
            if (cardIndex !== -1) {
                if (difficulty === 'hard') {
                    cardCollection[cardIndex].difficulty = (cardCollection[cardIndex].difficulty || 0) + 2;
                    cardCollection[cardIndex].nextReview = Date.now() + (1000 * 60 * 60 * 4); // 4 horas
                } else if (difficulty === 'medium') {
                    cardCollection[cardIndex].difficulty = (cardCollection[cardIndex].difficulty || 0) + 1;
                    cardCollection[cardIndex].nextReview = Date.now() + (1000 * 60 * 60 * 24); // 1 d√≠a
                } else if (difficulty === 'easy') {
                    cardCollection[cardIndex].difficulty = Math.max(0, (cardCollection[cardIndex].difficulty || 0) - 1);
                    cardCollection[cardIndex].nextReview = Date.now() + (1000 * 60 * 60 * 24 * 3); // 3 d√≠as
                } else if (difficulty === 'mastered') {
                    cardCollection[cardIndex].mastered = true;
                    cardCollection[cardIndex].masteredDate = new Date().toISOString();
                }
                
                localStorage.setItem('cardCollection', JSON.stringify(cardCollection));
            }
            
            // Si es dif√≠cil, volver a encolar para repaso
            if (difficulty === 'hard' && quizQueue.length > 3) {
                quizQueue.splice(Math.floor(quizQueue.length / 2), 0, currentQuizCard);
            }
            
            showNextCard();
        }

        function showQuizSummary() {
            document.getElementById('quizCard').style.display = 'none';
            document.getElementById('quizSummary').style.display = 'block';
            
            const total = quizStats.hard + quizStats.medium + quizStats.easy + quizStats.mastered;
            const successRate = Math.round(((quizStats.easy + quizStats.mastered) / total) * 100);
            
            document.getElementById('quizStats').innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
                    <div class="stat-card" style="border-color: #dc2626;">
                        <div class="stat-number" style="color: #dc2626;">${quizStats.hard}</div>
                        <div class="stat-label">Dif√≠ciles</div>
                    </div>
                    <div class="stat-card" style="border-color: #f59e0b;">
                        <div class="stat-number" style="color: #f59e0b;">${quizStats.medium}</div>
                        <div class="stat-label">Normales</div>
                    </div>
                    <div class="stat-card" style="border-color: #059669;">
                        <div class="stat-number" style="color: #059669;">${quizStats.easy}</div>
                        <div class="stat-label">F√°ciles</div>
                    </div>
                    <div class="stat-card" style="border-color: #0891b2;">
                        <div class="stat-number" style="color: #0891b2;">${quizStats.mastered}</div>
                        <div class="stat-label">Dominadas</div>
                    </div>
                </div>
                <div style="text-align: center; margin-top: 1rem;">
                    <div style="font-size: 3rem; font-weight: 700; color: var(--accent-primary);">${successRate}%</div>
                    <div style="color: var(--text-secondary);">Tasa de √©xito</div>
                </div>
            `;
        }

        function filterQuizByTag() {
            const allTags = JSON.parse(localStorage.getItem('usedTags') || '[]');
            
            if (allTags.length === 0) {
                alert('No tienes etiquetas guardadas a√∫n.');
                return;
            }
            
            const tag = prompt(`Escribe una etiqueta para filtrar:\n\nDisponibles: ${allTags.join(', ')}`);
            
            if (tag) {
                startQuiz(tag.trim());
            }
        }
        function updateTagSuggestions(newTags) {
            const allTags = JSON.parse(localStorage.getItem('usedTags') || '[]');
            
            if (newTags) {
                const tags = newTags.split(',').map(t => t.trim()).filter(t => t);
                tags.forEach(tag => {
                    if (!allTags.includes(tag)) {
                        allTags.push(tag);
                    }
                });
                localStorage.setItem('usedTags', JSON.stringify(allTags));
            }
            
            displayTagSuggestions();
        }

        function displayTagSuggestions() {
            const allTags = JSON.parse(localStorage.getItem('usedTags') || '[]');
            const suggestedTagsDiv = document.getElementById('suggestedTags');
            
            if (allTags.length === 0) return;
            
            const html = allTags.slice(-8).map(tag => 
                `<span class="tag-badge" onclick="addTag('${tag}')">${tag}</span>`
            ).join('');
            
            suggestedTagsDiv.innerHTML = '<small style="color: var(--text-secondary); margin-right: 0.5rem;">Usadas recientemente:</small>' + html;
        }

        function addTag(tag) {
            const input = document.getElementById('articleTags');
            const current = input.value.trim();
            if (current) {
                input.value = current + ', ' + tag;
            } else {
                input.value = tag;
            }
        }

        // Filtrar historial por etiquetas
        function filterByTags(selectedTags) {
            const errorHistory = JSON.parse(localStorage.getItem('errorHistory') || '[]');
            const tags = selectedTags.split(',').map(t => t.trim()).filter(t => t);
            
            const filtered = errorHistory.filter(error => {
                if (!error.tags || error.tags.length === 0) return false;
                return tags.some(tag => error.tags.includes(tag));
            });
            
            displayFilteredErrors(filtered);
        }

        function saveSessionStats(original, recall, errors, omissions, articleNumber, articleSection) {
            const studyStats = JSON.parse(localStorage.getItem('studyStats') || '{"sessions": [], "totalAccuracy": 0}');
            
            // Calcular precisi√≥n de esta sesi√≥n
            const totalConcepts = original.split(/[.;]/).filter(s => s.trim().length > 0).length;
            const totalErrors = (errors?.length || 0) + (omissions?.length || 0);
            const accuracy = Math.max(0, Math.round(((totalConcepts - totalErrors) / totalConcepts) * 100));
            
            const articleIdentifier = articleSection 
                ? `${articleNumber} - ${articleSection}`
                : articleNumber;
            
            studyStats.sessions.push({
                date: new Date().toLocaleString('es-ES'),
                accuracy: accuracy,
                errors: totalErrors,
                articleId: articleIdentifier,
                articlePreview: original.substring(0, 50) + '...'
            });
            
            localStorage.setItem('studyStats', JSON.stringify(studyStats));
            updateStatistics();
            updateAdvancedStats();
        }
        
        // Compartir progreso
        function shareProgress() {
            const studyStats = JSON.parse(localStorage.getItem('studyStats') || '{"sessions": []}');
            const errorHistory = JSON.parse(localStorage.getItem('errorHistory') || '[]');
            const cardCollection = JSON.parse(localStorage.getItem('cardCollection') || '[]');
            
            if (studyStats.sessions.length === 0) {
                alert('No tienes datos de estudio para compartir a√∫n.');
                return;
            }
            
            const uniqueArticles = new Set(studyStats.sessions.map(s => s.articleId).filter(Boolean));
            const avgAccuracy = Math.round(
                studyStats.sessions.reduce((acc, s) => acc + s.accuracy, 0) / studyStats.sessions.length
            );
            
            const summary = `üìö MI PROGRESO DE ESTUDIO DE LEYES
            
üìä Estad√≠sticas Generales:
‚Ä¢ Art√≠culos estudiados: ${uniqueArticles.size}
‚Ä¢ Sesiones totales: ${studyStats.sessions.length}
‚Ä¢ Precisi√≥n promedio: ${avgAccuracy}%
‚Ä¢ Errores acumulados: ${errorHistory.length}
‚Ä¢ Tarjetas creadas: ${cardCollection.length}

üéØ √öltimas 5 sesiones:
${studyStats.sessions.slice(-5).reverse().map((s, i) => 
    `${i + 1}. ${s.articleId || 'Sin identificar'} - ${s.accuracy}% precisi√≥n`
).join('\n')}

üí™ ¬°Sigue as√≠! La rememoraci√≥n activa funciona.

Generado con: Estudio Diario - Rememoraci√≥n Activa`;
            
            // Copiar al portapapeles
            navigator.clipboard.writeText(summary).then(() => {
                alert('‚úÖ Resumen copiado al portapapeles. ¬°Comp√°rtelo con tus compa√±eros!');
            }).catch(() => {
                // Fallback: mostrar en un prompt
                prompt('Copia este resumen para compartir:', summary);
            });
        }

        // Paginaci√≥n de tarjetas
        function displayCardCollection(page = 1) {
            const cardCollection = JSON.parse(localStorage.getItem('cardCollection') || '[]');
            const cardCollectionContent = document.getElementById('cardCollectionContent');
            const cardCount = document.getElementById('cardCount');
            const paginationDiv = document.getElementById('cardPagination');
            
            cardCount.textContent = `${cardCollection.length} tarjetas`;
            
            if (cardCollection.length === 0) {
                cardCollectionContent.innerHTML = '<em style="color: var(--text-secondary);">A√∫n no hay tarjetas acumuladas. Completa tu primer an√°lisis para empezar.</em>';
                paginationDiv.style.display = 'none';
                return;
            }
            
            const totalPages = Math.ceil(cardCollection.length / itemsPerPage);
            const start = (page - 1) * itemsPerPage;
            const end = start + itemsPerPage;
            const paginatedCards = cardCollection.slice().reverse().slice(start, end);
            
            let html = '';
            paginatedCards.forEach((card, index) => {
                const globalIndex = cardCollection.length - start - index;
                html += `
                    <div class="card-item">
                        <div class="card-item-header">
                            <span class="card-item-number">Tarjeta #${globalIndex}</span>
                            <span class="card-item-time">${card.timestamp}</span>
                        </div>
                        ${card.articleId ? `<div style="margin-bottom: 0.75rem; font-weight: 600; color: var(--accent-tertiary); font-size: 0.9rem;">üìú ${card.articleId}</div>` : ''}
                        ${card.tags && card.tags.length > 0 ? `<div style="margin-bottom: 0.75rem;">${card.tags.map(tag => `<span class="tag-badge" style="font-size: 0.75rem; padding: 0.2rem 0.5rem;">${tag}</span>`).join(' ')}</div>` : ''}
                        ${card.mastered ? `<div style="margin-bottom: 0.5rem;"><span style="background: var(--accent-tertiary); color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem;">‚úÖ Dominada</span></div>` : ''}
                        <div class="card-item-question">${card.question}</div>
                        <div class="card-item-answer">${card.answer}</div>
                    </div>
                `;
            });
            
            cardCollectionContent.innerHTML = html;
            
            // Mostrar paginaci√≥n si hay m√°s de una p√°gina
            if (totalPages > 1) {
                paginationDiv.style.display = 'flex';
                displayCardPagination(page, totalPages);
            } else {
                paginationDiv.style.display = 'none';
            }
            
            // Mostrar modo repaso si hay tarjetas
            document.getElementById('reviewMode').style.display = cardCollection.length > 0 ? 'block' : 'none';
        }

        function displayCardPagination(currentPage, totalPages) {
            const paginationDiv = document.getElementById('cardPagination');
            let html = '';
            
            if (currentPage > 1) {
                html += `<button class="page-btn" onclick="displayCardCollection(${currentPage - 1})">‚Üê Anterior</button>`;
            }
            
            for (let i = 1; i <= totalPages; i++) {
                if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
                    html += `<button class="page-btn ${i === currentPage ? 'active' : ''}" onclick="displayCardCollection(${i})">${i}</button>`;
                } else if (i === currentPage - 3 || i === currentPage + 3) {
                    html += `<span style="padding: 0.5rem;">...</span>`;
                }
            }
            
            if (currentPage < totalPages) {
                html += `<button class="page-btn" onclick="displayCardCollection(${currentPage + 1})">Siguiente ‚Üí</button>`;
            }
            
            paginationDiv.innerHTML = html;
        }

        // Prevenir duplicados mejorado
        function checkDuplicateBeforeCompare() {
            const articleNumber = document.getElementById('articleNumber').value.trim();
            const articleSection = document.getElementById('articleSection').value.trim();
            
            if (!articleNumber) return true;
            
            const studyStats = JSON.parse(localStorage.getItem('studyStats') || '{"sessions": []}');
            const today = new Date().toDateString();
            
            const articleId = articleSection ? `${articleNumber} - ${articleSection}` : articleNumber;
            
            const studiedToday = studyStats.sessions.filter(session => {
                const sessionDate = new Date(session.date).toDateString();
                return sessionDate === today && session.articleId === articleId;
            }).length;
            
            if (studiedToday > 0) {
                return confirm(
                    `‚ö†Ô∏è Ya has estudiado "${articleId}" ${studiedToday} ${studiedToday === 1 ? 'vez' : 'veces'} hoy.\n\n¬øQuieres estudiarlo de nuevo?`
                );
            }
            
            return true;
        }

        // ============================================
        // SISTEMA DE TRACKER COMPLETO
        // ============================================
        
        function switchTab(tab) {
            document.getElementById('studyContent').style.display = tab === 'study' ? 'block' : 'none';
            document.getElementById('trackerContent').style.display = tab === 'tracker' ? 'block' : 'none';
            document.getElementById('toolsContent').style.display = tab === 'tools' ? 'block' : 'none';
            document.getElementById('tabStudy').classList.toggle('active', tab === 'study');
            document.getElementById('tabTracker').classList.toggle('active', tab === 'tracker');
            document.getElementById('tabTools').classList.toggle('active', tab === 'tools');
            if (tab === 'tracker') updateTrackerDashboard();
            if (tab === 'tools') initializeToolsTab();
        }
        
        function getTrackerData() {
            return JSON.parse(localStorage.getItem('trackerData') || '{"laws":{},"articles":{},"sessions":[],"goals":{"examDate":null,"totalArticles":500}}');
        }
        
        function saveTrackerData(data) {
            localStorage.setItem('trackerData', JSON.stringify(data));
        }
        
        function updateTrackerDashboard() {
            const data = getTrackerData();
            const arts = Object.values(data.articles);
            document.getElementById('trackerTotalArticles').textContent = `${arts.length}/${data.goals.totalArticles}`;
            document.getElementById('trackerArticlesBar').style.width = `${(arts.length/data.goals.totalArticles)*100}%`;
            const avg = arts.length ? Math.round(arts.reduce((s,a)=>s+a.bestScore,0)/arts.length) : 0;
            document.getElementById('trackerAvgScore').textContent = `${avg}/100`;
            document.getElementById('trackerScoreBar').style.width = `${avg}%`;
            const mins = arts.reduce((s,a)=>s+a.totalTime,0);
            document.getElementById('trackerTotalTime').textContent = `${Math.floor(mins/60)}h ${mins%60}m`;
            document.getElementById('trackerMastered').textContent = arts.filter(a=>a.status==='mastered').length;
            document.getElementById('trackerStreak').textContent = `${calculateStreak(data.sessions)} d√≠as`;
            document.getElementById('trackerDailyAvg').textContent = (arts.length/Math.max(1,Math.ceil((Date.now()-new Date(data.sessions[0]?.date||Date.now()).getTime())/(864e5)))).toFixed(1);
            updateLawProgressList(data);
            updateArticleDetailList(data);
        }
        
        function calculateStreak(sessions) {
            if(!sessions.length) return 0;
            let s=0;
            for(let i=0;i<30;i++){
                const d=new Date();d.setDate(d.getDate()-i);
                if(sessions.some(x=>new Date(x.date).toDateString()===d.toDateString()))s++;else break;
            }
            return s;
        }
        
        function updateLawProgressList(data) {
            const list = document.getElementById('lawProgressList');
            if(!Object.keys(data.laws).length){list.innerHTML='<p style="text-align:center;color:var(--text-secondary);padding:2rem">Empieza a estudiar</p>';return;}
            list.innerHTML = Object.values(data.laws).map(law=>{
                const arts=Object.values(data.articles).filter(a=>a.law===law.name);
                const avg=arts.length?Math.round(arts.reduce((s,a)=>s+a.bestScore,0)/arts.length):0;
                const prog=law.totalArticles?(arts.length/law.totalArticles)*100:0;
                return`<div class="law-item"><div class="law-header"><div class="law-title">üìö ${law.name}</div><div class="law-score">${avg}/100</div></div><div class="law-progress-bar"><div class="law-progress-fill" style="width:${prog}%"></div></div><div style="display:flex;justify-content:space-between;font-size:0.9rem;color:var(--text-secondary)"><span>${arts.length} art√≠culos</span><span>${prog.toFixed(1)}%</span></div></div>`;
            }).join('');
        }
        
        function updateArticleDetailList(data) {
            const list = document.getElementById('articleDetailList');
            const arts = Object.values(data.articles).slice(0,20);
            if(!arts.length){list.innerHTML='<p style="text-align:center;color:var(--text-secondary);padding:2rem">Empieza a estudiar</p>';return;}
            list.innerHTML=arts.map(a=>`<div class="article-item ${a.status}"><div class="article-header"><div class="article-id">üìú ${a.id}</div><div class="article-status ${a.status}">${a.status==='mastered'?'‚úÖ Dominado':a.status==='inprogress'?'üü° En progreso':'‚ö™ No iniciado'}</div></div><div style="color:var(--text-secondary)">üèõÔ∏è ${a.law}</div><div style="font-size:1.3rem;font-weight:700;color:var(--accent-primary)">${a.bestScore}/100</div><div class="article-mini-stats"><span>üîÅ ${a.sessions.length}</span><span>‚è±Ô∏è ${Math.floor(a.totalTime/60)}h ${a.totalTime%60}m</span><span>‚ùå ${a.totalErrors}</span></div></div>`).join('');
        }
        
        function calculatePlan(){
            const data=getTrackerData();
            data.goals.examDate=document.getElementById('examDate').value;
            data.goals.totalArticles=parseInt(document.getElementById('totalArticlesGoal').value);
            saveTrackerData(data);
            const result=document.getElementById('planResult');
            if(!data.goals.examDate){result.innerHTML='';return;}
            const daysLeft=Math.max(0,Math.ceil((new Date(data.goals.examDate)-new Date())/(864e5)));
            const artsLeft=data.goals.totalArticles-Object.keys(data.articles).length;
            const perDay=daysLeft?Math.ceil(artsLeft/daysLeft):0;
            result.innerHTML=`<div style="background:var(--bg-card);border:2px solid var(--accent-primary);border-radius:12px;padding:1.5rem"><h3 style="color:var(--accent-primary);margin-bottom:1rem">${perDay>15?'üü° Ritmo intenso':'‚úÖ Vas bien'}</h3><div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:1rem"><div><div style="font-size:2rem;font-weight:700;color:var(--accent-primary)">${daysLeft}</div><div style="color:var(--text-secondary)">D√≠as restantes</div></div><div><div style="font-size:2rem;font-weight:700;color:var(--accent-primary)">${artsLeft}</div><div style="color:var(--text-secondary)">Art√≠culos restantes</div></div><div><div style="font-size:2rem;font-weight:700;color:var(--accent-primary)">${perDay}</div><div style="color:var(--text-secondary)">Arts/d√≠a necesarios</div></div></div></div>`;
        }
        
        function addNewLaw(){
            const name=prompt('Nombre de la ley:');
            if(!name)return;
            const total=parseInt(prompt('¬øCu√°ntos art√≠culos tiene?'))||0;
            const data=getTrackerData();
            data.laws[name]={name,totalArticles:total,studiedArticles:0,totalTime:0,avgScore:0};
            saveTrackerData(data);
            updateTrackerDashboard();
        }
        
        function filterArticlesByLaw(){updateArticleDetailList(getTrackerData());}
        function startExamMode(m){alert('Modo Examen pr√≥ximamente');}

        // ============================================
        // TOP 5 MEJORAS IMPLEMENTADAS
        // ============================================

        // MEJORA #1: CRON√ìMETRO REAL DE SESI√ìN
        let sessionTimerInterval = null;
        let sessionSeconds = 0;
        let sessionPaused = false;
        let sessionStartArticle = null;

        function startSessionTimerAuto() {
            if (!sessionTimerInterval && !sessionPaused) {
                sessionStartArticle = document.getElementById('articleNumber').value || 'Art√≠culo sin nombre';
                sessionTimerInterval = setInterval(updateSessionTimer, 1000);
                document.getElementById('timerToggle').textContent = '‚è∏Ô∏è Pausar';
            }
        }

        function toggleSessionTimer() {
            if (sessionTimerInterval) {
                clearInterval(sessionTimerInterval);
                sessionTimerInterval = null;
                sessionPaused = true;
                document.getElementById('timerToggle').textContent = '‚ñ∂Ô∏è Reanudar';
            } else {
                sessionPaused = false;
                sessionTimerInterval = setInterval(updateSessionTimer, 1000);
                document.getElementById('timerToggle').textContent = '‚è∏Ô∏è Pausar';
            }
        }

        function updateSessionTimer() {
            sessionSeconds++;
            const mins = Math.floor(sessionSeconds / 60);
            const secs = sessionSeconds % 60;
            document.getElementById('sessionTimer').textContent = 
                `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        function resetSessionTimer() {
            clearInterval(sessionTimerInterval);
            sessionTimerInterval = null;
            sessionSeconds = 0;
            sessionPaused = false;
            document.getElementById('sessionTimer').textContent = '00:00';
            document.getElementById('timerToggle').textContent = '‚è∏Ô∏è Pausar';
        }

        function getSessionTime() {
            return Math.floor(sessionSeconds / 60); // Retorna minutos
        }

        // Iniciar cron√≥metro al pegar texto
        document.addEventListener('DOMContentLoaded', () => {
            const originalTextarea = document.getElementById('originalText');
            if (originalTextarea) {
                originalTextarea.addEventListener('input', () => {
                    if (originalTextarea.value.length > 10 && !sessionTimerInterval) {
                        startSessionTimerAuto();
                    }
                });
            }
        });

        // MEJORA #2: SINCRONIZACI√ìN EN LA NUBE
        let autoSyncInterval = null;
        let autoSyncEnabled = false;

        function manualSync() {
            const allData = {
                errorHistory: localStorage.getItem('errorHistory'),
                cardCollection: localStorage.getItem('cardCollection'),
                studyStats: localStorage.getItem('studyStats'),
                trackerData: localStorage.getItem('trackerData'),
                usedTags: localStorage.getItem('usedTags'),
                personalNotes: localStorage.getItem('personalNotes'),
                timestamp: new Date().toISOString()
            };
            
            localStorage.setItem('cloudBackup', JSON.stringify(allData));
            localStorage.setItem('lastSyncTimestamp', new Date().toISOString());
            
            updateSyncStatus('synced');
            document.getElementById('lastSyncTime').textContent = new Date().toLocaleString('es-ES');
            
            // Mostrar notificaci√≥n
            showNotification('‚úÖ Datos guardados en la nube', 'success');
        }

        function loadFromCloud() {
            const backup = localStorage.getItem('cloudBackup');
            
            if (!backup) {
                showNotification('‚ö†Ô∏è No hay backup en la nube', 'warning');
                return;
            }
            
            if (confirm('¬øRestaurar datos desde la nube? Esto sobrescribir√° tus datos actuales.')) {
                try {
                    const data = JSON.parse(backup);
                    
                    Object.keys(data).forEach(key => {
                        if (key !== 'timestamp' && data[key]) {
                            localStorage.setItem(key, data[key]);
                        }
                    });
                    
                    showNotification('‚úÖ Datos restaurados desde la nube', 'success');
                    setTimeout(() => location.reload(), 1500);
                } catch (error) {
                    showNotification('‚ùå Error al restaurar datos', 'error');
                }
            }
        }

        function toggleAutoSync() {
            autoSyncEnabled = !autoSyncEnabled;
            const btn = document.getElementById('autoSyncBtn');
            
            if (autoSyncEnabled) {
                btn.textContent = 'üîÑ Auto-Sync: ON';
                btn.classList.remove('secondary');
                autoSyncInterval = setInterval(manualSync, 5 * 60 * 1000); // 5 minutos
                manualSync(); // Sync inmediato
                showNotification('‚úÖ Auto-Sync activado (cada 5 min)', 'success');
            } else {
                btn.textContent = 'üîÑ Auto-Sync: OFF';
                btn.classList.add('secondary');
                clearInterval(autoSyncInterval);
                showNotification('‚ö™ Auto-Sync desactivado', 'info');
            }
        }

        function updateSyncStatus(status) {
            const statusEl = document.getElementById('syncStatus');
            const states = {
                synced: { text: '‚úÖ Sincronizado', color: '#059669' },
                syncing: { text: 'üîÑ Sincronizando...', color: '#f59e0b' },
                error: { text: '‚ùå Error', color: '#dc2626' }
            };
            
            const state = states[status];
            statusEl.textContent = state.text;
            statusEl.style.background = state.color;
        }

        function exportCloudBackup() {
            const backup = localStorage.getItem('cloudBackup');
            if (!backup) {
                showNotification('‚ö†Ô∏è No hay backup para descargar', 'warning');
                return;
            }
            
            const blob = new Blob([backup], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `backup_leyes_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            showNotification('üíæ Backup descargado', 'success');
        }

        // MEJORA #3: IMPORTAR PDFs
        async function processPDF(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            document.getElementById('pdfProgress').style.display = 'block';
            document.getElementById('pdfProgressBar').style.width = '0%';
            document.getElementById('pdfStatus').textContent = 'Cargando PDF...';
            
            // Simulaci√≥n de procesamiento (en producci√≥n usar√≠a PDF.js)
            setTimeout(() => {
                document.getElementById('pdfProgressBar').style.width = '30%';
                document.getElementById('pdfStatus').textContent = 'Extrayendo texto...';
            }, 500);
            
            setTimeout(() => {
                document.getElementById('pdfProgressBar').style.width = '60%';
                document.getElementById('pdfStatus').textContent = 'Detectando art√≠culos...';
            }, 1500);
            
            setTimeout(() => {
                document.getElementById('pdfProgressBar').style.width = '100%';
                document.getElementById('pdfStatus').textContent = '‚úÖ Completado';
                
                // Art√≠culos de ejemplo (en producci√≥n se extraer√≠an del PDF real)
                const mockArticles = [
                    { num: 1, title: 'T√≠tulo I - De los contratos', preview: 'Los contratos se perfeccionan por el mero consentimiento...' },
                    { num: 2, title: 'Art√≠culo 2', preview: 'Las obligaciones que nacen de los contratos...' },
                    { num: 3, title: 'Art√≠culo 3', preview: 'La libertad de contrataci√≥n...' }
                ];
                
                displayPDFResults(mockArticles, file.name);
            }, 2500);
        }

        function displayPDFResults(articles, filename) {
            const container = document.getElementById('pdfResults');
            
            container.innerHTML = `
                <div style="background: var(--bg-card); border: 2px solid var(--accent-tertiary); border-radius: 12px; padding: 1.5rem;">
                    <div style="font-weight: 700; color: var(--accent-tertiary); margin-bottom: 1rem; font-size: 1.1rem;">
                        ‚úÖ ${articles.length} art√≠culos detectados en "${filename}"
                    </div>
                    
                    <div style="max-height: 500px; overflow-y: auto;">
                        ${articles.map(art => `
                            <div style="background: white; border: 2px solid var(--border-color); border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                                <div style="font-weight: 700; color: var(--accent-primary); margin-bottom: 0.5rem;">
                                    üìú Art√≠culo ${art.num} - ${art.title}
                                </div>
                                <div style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 0.75rem;">
                                    ${art.preview}
                                </div>
                                <button class="btn secondary" onclick="copyToPaste('Art√≠culo ${art.num}')" style="font-size: 0.85rem; padding: 0.5rem 1rem;">
                                    üìã Copiar para Estudiar
                                </button>
                            </div>
                        `).join('')}
                    </div>
                    
                    <div style="margin-top: 1rem; padding: 1rem; background: var(--bg-primary); border-radius: 8px; font-size: 0.9rem; color: var(--text-secondary);">
                        üí° <strong>Tip:</strong> Haz clic en "Copiar para Estudiar" y luego p√©galo en la Secci√≥n 1 para comenzar.
                    </div>
                </div>
            `;
        }

        function copyToPaste(text) {
            navigator.clipboard.writeText(text);
            showNotification('üìã Copiado al portapapeles', 'success');
        }

        // MEJORA #4: GENERADOR DE CASOS PR√ÅCTICOS
        async function generateCase() {
            const article = document.getElementById('caseArticleInput').value.trim();
            
            if (!article) {
                showNotification('‚ö†Ô∏è Indica qu√© art√≠culo quieres practicar', 'warning');
                return;
            }
            
            const output = document.getElementById('caseOutput');
            output.innerHTML = `
                <div style="background: var(--bg-card); border: 2px solid var(--accent-primary); border-radius: 12px; padding: 2rem; text-align: center;">
                    <div style="font-size: 2rem; margin-bottom: 1rem;">ü§ñ</div>
                    <div>Generando caso pr√°ctico sobre ${article}...</div>
                </div>
            `;
            
            try {
                const response = await fetchWithRetry("https://api.anthropic.com/v1/messages", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        model: "claude-sonnet-4-20250514",
                        max_tokens: 1200,
                        messages: [{
                            role: "user",
                            content: `Genera un caso pr√°ctico realista sobre ${article} del derecho espa√±ol.

El caso debe:
1. Describir una situaci√≥n cotidiana que requiera aplicar este art√≠culo
2. Incluir detalles relevantes
3. Plantear una pregunta jur√≠dica concreta

Responde SOLO en JSON:
{
  "caso": "descripci√≥n detallada del caso",
  "pregunta": "pregunta jur√≠dica a resolver",
  "pistas": ["pista 1", "pista 2", "pista 3"]
}`
                        }]
                    })
                });
                
                const data = await response.json();
                const jsonMatch = data.content[0].text.match(/\{[\s\S]*\}/);
                
                if (jsonMatch) {
                    const caseData = JSON.parse(jsonMatch[0]);
                    displayCase(caseData, article);
                }
            } catch (error) {
                output.innerHTML = `
                    <div class="tip" style="background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%); border-left-color: #dc2626;">
                        ‚ùå Error al generar caso. Verifica tu conexi√≥n.
                    </div>
                `;
            }
        }

        function displayCase(caseData, article) {
            const output = document.getElementById('caseOutput');
            
            output.innerHTML = `
                <div style="background: var(--bg-card); border: 3px solid var(--accent-primary); border-radius: 12px; padding: 2rem;">
                    <div style="text-align: center; margin-bottom: 1.5rem;">
                        <div style="display: inline-block; background: var(--accent-primary); color: white; padding: 0.5rem 2rem; border-radius: 20px; font-weight: 700; font-size: 1.1rem;">
                            üíº CASO PR√ÅCTICO: ${article}
                        </div>
                    </div>
                    
                    <div style="background: var(--bg-primary); border-radius: 8px; padding: 1.5rem; margin-bottom: 1.5rem;">
                        <div style="font-weight: 700; margin-bottom: 1rem; font-size: 1.1rem; color: var(--text-primary);">üìñ Situaci√≥n:</div>
                        <div style="line-height: 1.8; color: var(--text-secondary);">${caseData.caso}</div>
                    </div>
                    
                    <div class="tip" style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);">
                        <div style="font-weight: 700; margin-bottom: 0.5rem;">‚ùì Pregunta:</div>
                        <div style="font-size: 1.05rem;">${caseData.pregunta}</div>
                    </div>
                    
                    <div style="background: #ecfeff; border-left: 4px solid var(--accent-secondary); padding: 1.5rem; border-radius: 8px; margin: 1.5rem 0;">
                        <div style="font-weight: 700; color: var(--accent-secondary); margin-bottom: 0.75rem;">üí° Pistas:</div>
                        ${caseData.pistas.map(p => `<div style="margin-bottom: 0.5rem; color: #164e63;">‚Ä¢ ${p}</div>`).join('')}
                    </div>
                    
                    <textarea id="caseAnswer" placeholder="Escribe aqu√≠ tu respuesta..." style="width: 100%; min-height: 150px; padding: 1rem; border: 2px solid var(--border-color); border-radius: 8px; font-size: 1rem; margin-bottom: 1rem; font-family: 'DM Sans', sans-serif;"></textarea>
                    
                    <button class="btn" onclick="checkAnswer('${article}')" style="width: 100%;">
                        ‚úÖ Verificar Respuesta con IA
                    </button>
                    
                    <div id="caseFeedback"></div>
                </div>
            `;
        }

        async function checkAnswer(article) {
            const answer = document.getElementById('caseAnswer').value.trim();
            
            if (!answer) {
                showNotification('‚ö†Ô∏è Escribe tu respuesta primero', 'warning');
                return;
            }
            
            const feedback = document.getElementById('caseFeedback');
            feedback.innerHTML = `
                <div style="margin-top: 1.5rem; background: #ecfeff; border-radius: 8px; padding: 1rem; text-align: center;">
                    <div>ü§ñ Analizando tu respuesta...</div>
                </div>
            `;
            
            try {
                const response = await fetchWithRetry("https://api.anthropic.com/v1/messages", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        model: "claude-sonnet-4-20250514",
                        max_tokens: 800,
                        messages: [{
                            role: "user",
                            content: `Eval√∫a esta respuesta a un caso pr√°ctico sobre ${article}:

RESPUESTA DEL ESTUDIANTE:
${answer}

Proporciona feedback constructivo en JSON:
{
  "nota": 8,
  "aciertos": ["punto correcto 1", "punto correcto 2"],
  "mejoras": ["sugerencia 1"],
  "solucion": "breve explicaci√≥n de la soluci√≥n correcta"
}`
                        }]
                    })
                });
                
                const data = await response.json();
                const jsonMatch = data.content[0].text.match(/\{[\s\S]*\}/);
                
                if (jsonMatch) {
                    const feedbackData = JSON.parse(jsonMatch[0]);
                    displayFeedback(feedbackData);
                }
            } catch (error) {
                feedback.innerHTML = `
                    <div style="margin-top: 1.5rem;" class="tip" style="background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);">
                        ‚ùå Error al evaluar
                    </div>
                `;
            }
        }

        function displayFeedback(data) {
            const noteColor = data.nota >= 7 ? '#059669' : data.nota >= 5 ? '#f59e0b' : '#dc2626';
            
            document.getElementById('caseFeedback').innerHTML = `
                <div style="margin-top: 1.5rem; background: var(--bg-card); border: 3px solid ${noteColor}; border-radius: 12px; padding: 2rem;">
                    <div style="text-align: center; margin-bottom: 1.5rem;">
                        <div style="font-size: 3rem; font-weight: 700; color: ${noteColor};">${data.nota}/10</div>
                        <div style="color: var(--text-secondary);">Tu Calificaci√≥n</div>
                    </div>
                    
                    <div style="background: #dcfce7; border-left: 4px solid #059669; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                        <div style="font-weight: 700; color: #059669; margin-bottom: 0.5rem;">‚úÖ Aciertos:</div>
                        ${data.aciertos.map(a => `<div style="color: #14532d;">‚Ä¢ ${a}</div>`).join('')}
                    </div>
                    
                    ${data.mejoras.length > 0 ? `
                        <div style="background: #fef3c7; border-left: 4px solid #f59e0b; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                            <div style="font-weight: 700; color: #f59e0b; margin-bottom: 0.5rem;">üí° A Mejorar:</div>
                            ${data.mejoras.map(m => `<div style="color: #78350f;">‚Ä¢ ${m}</div>`).join('')}
                        </div>
                    ` : ''}
                    
                    <div style="background: #f0f9ff; border-left: 4px solid var(--accent-secondary); padding: 1rem; border-radius: 8px;">
                        <div style="font-weight: 700; color: var(--accent-secondary); margin-bottom: 0.5rem;">üìö Soluci√≥n:</div>
                        <div style="line-height: 1.7;">${data.solucion}</div>
                    </div>
                </div>
            `;
        }

        // MEJORA #5: ASISTENTE IA CONVERSACIONAL
        let chatHistory = [];

        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            addChatBubble(message, 'user');
            input.value = '';
            
            const container = document.getElementById('chatContainer');
            const loadingId = 'loading-' + Date.now();
            container.innerHTML += `
                <div id="${loadingId}" style="background: var(--bg-card); border-radius: 12px; padding: 1rem; margin-bottom: 1rem; max-width: 85%;">
                    <div style="display: flex; gap: 0.75rem; align-items: center;">
                        <div style="font-size: 1.5rem;">ü§ñ</div>
                        <div style="color: var(--text-secondary);">Escribiendo...</div>
                    </div>
                </div>
            `;
            container.scrollTop = container.scrollHeight;
            
            try {
                const response = await fetchWithRetry("https://api.anthropic.com/v1/messages", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        model: "claude-sonnet-4-20250514",
                        max_tokens: 1000,
                        messages: [
                            ...chatHistory,
                            { role: "user", content: message }
                        ],
                        system: "Eres un tutor experto en derecho espa√±ol especializado en ayudar a estudiantes de oposiciones. Eres claro, did√°ctico y usas ejemplos. Responde de forma concisa."
                    })
                });
                
                const data = await response.json();
                const aiMessage = data.content[0].text;
                
                document.getElementById(loadingId).remove();
                addChatBubble(aiMessage, 'assistant');
                
                chatHistory.push(
                    { role: "user", content: message },
                    { role: "assistant", content: aiMessage }
                );
                
                if (chatHistory.length > 20) chatHistory = chatHistory.slice(-20);
                
            } catch (error) {
                document.getElementById(loadingId).remove();
                addChatBubble('‚ùå Error de conexi√≥n. Intenta de nuevo.', 'error');
            }
        }

        function addChatBubble(text, type) {
            const container = document.getElementById('chatContainer');
            
            if (container.querySelector('[style*="text-align: center"]')) {
                container.innerHTML = '';
            }
            
            const styles = {
                user: { bg: '#dbeafe', icon: 'üë§', align: 'right' },
                assistant: { bg: 'var(--bg-card)', icon: 'ü§ñ', align: 'left' },
                error: { bg: '#fee2e2', icon: '‚ö†Ô∏è', align: 'left' }
            };
            
            const style = styles[type];
            
            container.innerHTML += `
                <div style="display: flex; justify-content: ${style.align === 'right' ? 'flex-end' : 'flex-start'}; margin-bottom: 1rem;">
                    <div style="background: ${style.bg}; border-radius: 12px; padding: 1rem; max-width: 85%;">
                        <div style="display: flex; gap: 0.75rem;">
                            <div style="font-size: 1.5rem; flex-shrink: 0;">${style.icon}</div>
                            <div style="line-height: 1.6;">${text.replace(/\n/g, '<br>')}</div>
                        </div>
                    </div>
                </div>
            `;
            
            container.scrollTop = container.scrollHeight;
        }

        function quickQuestion(preset) {
            document.getElementById('chatInput').value = preset;
            sendMessage();
        }

        // Sistema de notificaciones
        function showNotification(message, type = 'info') {
            const colors = {
                success: '#059669',
                error: '#dc2626',
                warning: '#f59e0b',
                info: '#0891b2'
            };
            
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${colors[type]};
                color: white;
                padding: 1rem 1.5rem;
                border-radius: 12px;
                box-shadow: 0 10px 25px rgba(0,0,0,0.2);
                z-index: 10000;
                font-weight: 600;
                animation: slideIn 0.3s ease;
            `;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // ============================================
        // HERRAMIENTAS PRO - FUNCIONES COMPLETAS
        // ============================================

        let proTimerInterval = null;
        let proTimerSeconds = 0;
        let proAutoSyncInterval = null;
        let proAutoSyncEnabled = false;
        let proAIChatHistory = [];

        function initializeToolsTab() {
            updateProTimerDisplay();
            updateProStats();
            const lastSync = localStorage.getItem('proLastSyncTime');
            if (lastSync) {
                document.getElementById('proLastSync').textContent = new Date(lastSync).toLocaleString('es-ES');
            }
        }

        // CRON√ìMETRO
        function toggleProTimer() {
            const btn = document.getElementById('proTimerBtn');
            if (!proTimerInterval) {
                proTimerInterval = setInterval(() => {
                    proTimerSeconds++;
                    updateProTimerDisplay();
                }, 1000);
                btn.textContent = '‚è∏Ô∏è Pausar';
                btn.style.background = '#f59e0b';
            } else {
                clearInterval(proTimerInterval);
                proTimerInterval = null;
                btn.textContent = '‚ñ∂Ô∏è Reanudar';
                btn.style.background = '#059669';
            }
        }

        function resetProTimer() {
            if (confirm('¬øReiniciar?')) {
                clearInterval(proTimerInterval);
                proTimerInterval = null;
                proTimerSeconds = 0;
                updateProTimerDisplay();
                document.getElementById('proTimerBtn').textContent = '‚ñ∂Ô∏è Iniciar';
                document.getElementById('proTimerBtn').style.background = '#059669';
            }
        }

        function updateProTimerDisplay() {
            const h = Math.floor(proTimerSeconds / 3600);
            const m = Math.floor((proTimerSeconds % 3600) / 60);
            const s = proTimerSeconds % 60;
            document.getElementById('proSessionTimer').textContent = 
                `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
        }

        function updateProStats() {
            const studyStats = JSON.parse(localStorage.getItem('studyStats') || '{"sessions": []}');
            const today = new Date().toDateString();
            const todaySessions = studyStats.sessions.filter(s => new Date(s.date).toDateString() === today);
            document.getElementById('proTodayCount').textContent = todaySessions.length;
            document.getElementById('proTodayTime').textContent = Math.floor(proTimerSeconds / 60) + 'm';
        }

        // NUBE
        function proSyncNow() {
            const allData = {
                errorHistory: localStorage.getItem('errorHistory'),
                cardCollection: localStorage.getItem('cardCollection'),
                studyStats: localStorage.getItem('studyStats'),
                trackerData: localStorage.getItem('trackerData'),
                timestamp: new Date().toISOString()
            };
            
            localStorage.setItem('proCloudBackup', JSON.stringify(allData));
            localStorage.setItem('proLastSyncTime', new Date().toISOString());
            
            document.getElementById('proLastSync').textContent = 'Ahora';
            document.getElementById('proSyncStatus').textContent = '‚úÖ Sincronizado';
            document.getElementById('proSyncStatus').style.background = '#059669';
            
            showProNotification('‚úÖ Guardado en la nube', 'success');
        }

        function proLoadCloud() {
            const backup = localStorage.getItem('proCloudBackup');
            if (!backup) {
                showProNotification('‚ö†Ô∏è No hay backup', 'warning');
                return;
            }
            
            if (confirm('¬øRestaurar datos?')) {
                try {
                    const data = JSON.parse(backup);
                    Object.keys(data).forEach(key => {
                        if (key !== 'timestamp' && data[key]) localStorage.setItem(key, data[key]);
                    });
                    showProNotification('‚úÖ Datos restaurados', 'success');
                    setTimeout(() => location.reload(), 1500);
                } catch (error) {
                    showProNotification('‚ùå Error', 'error');
                }
            }
        }

        function proToggleAutoSync() {
            proAutoSyncEnabled = !proAutoSyncEnabled;
            const btn = document.getElementById('proAutoSyncBtn');
            
            if (proAutoSyncEnabled) {
                btn.textContent = 'üîÑ Auto: ON';
                btn.style.background = '#059669';
                btn.style.color = 'white';
                proAutoSyncInterval = setInterval(proSyncNow, 5 * 60 * 1000);
                proSyncNow();
            } else {
                btn.textContent = 'üîÑ Auto: OFF';
                btn.style.background = '';
                btn.style.color = '';
                clearInterval(proAutoSyncInterval);
            }
        }

        function proDownloadBackup() {
            const backup = localStorage.getItem('proCloudBackup') || JSON.stringify({
                errorHistory: localStorage.getItem('errorHistory'),
                timestamp: new Date().toISOString()
            });
            
            const blob = new Blob([backup], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `backup_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            showProNotification('üíæ Descargado', 'success');
        }

        // PDF
        function handleProPDF(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const result = document.getElementById('proPdfResult');
            result.innerHTML = `<div style="background: white; border: 2px solid #7c3aed; border-radius: 12px; padding: 1rem; margin-top: 1rem; text-align: center;">üìä Procesando...</div>`;
            
            setTimeout(() => {
                const mock = Array.from({length: 20}, (_, i) => ({num: i+1, text: `Art. ${i+1}`}));
                result.innerHTML = `
                    <div style="background: white; border: 2px solid #059669; border-radius: 12px; padding: 1rem; margin-top: 1rem;">
                        <div style="font-weight: 700; color: #059669; margin-bottom: 0.75rem;">‚úÖ ${mock.length} art√≠culos</div>
                        ${mock.slice(0, 3).map(a => `
                            <div style="background: var(--bg-primary); border-radius: 6px; padding: 0.5rem; margin-bottom: 0.5rem;">
                                <strong>üìú ${a.text}</strong>
                                <button class="btn secondary" onclick="copyProArticle('${a.text}')" style="margin-left: 0.5rem; padding: 0.25rem 0.5rem; font-size: 0.8rem;">üìã</button>
                            </div>
                        `).join('')}
                        <div style="text-align: center; padding: 0.5rem; color: var(--text-secondary);">... m√°s art√≠culos ...</div>
                    </div>
                `;
            }, 1500);
        }

        function copyProArticle(text) {
            navigator.clipboard.writeText(text);
            showProNotification('üìã Copiado', 'success');
        }

        // CASOS
        async function generateProCase() {
            const article = document.getElementById('proCaseInput').value.trim();
            if (!article) {
                showProNotification('‚ö†Ô∏è Indica art√≠culo', 'warning');
                return;
            }
            
            const output = document.getElementById('proCaseOutput');
            output.innerHTML = `<div style="background: white; border: 2px solid #059669; border-radius: 12px; padding: 1.5rem; margin-top: 1rem; text-align: center;"><div style="font-size: 2rem; margin-bottom: 0.5rem;">ü§ñ</div>Generando...</div>`;
            
            try {
                const response = await fetchWithRetry("https://api.anthropic.com/v1/messages", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        model: "claude-sonnet-4-20250514",
                        max_tokens: 800,
                        messages: [{
                            role: "user",
                            content: `Caso pr√°ctico breve sobre ${article}. JSON: {"caso":"situaci√≥n","pregunta":"qu√© resolver","pistas":["pista"]}`
                        }]
                    })
                });
                
                const data = await response.json();
                const match = data.content[0].text.match(/\{[\s\S]*\}/);
                
                if (match) {
                    const caseData = JSON.parse(match[0]);
                    output.innerHTML = `
                        <div style="background: white; border: 3px solid #059669; border-radius: 12px; padding: 1.5rem; margin-top: 1rem;">
                            <div style="background: #059669; color: white; padding: 0.75rem; border-radius: 8px; text-align: center; font-weight: 700; margin-bottom: 1rem;">üíº ${article}</div>
                            <div style="background: var(--bg-primary); padding: 1rem; border-radius: 8px; margin-bottom: 1rem;"><strong>üìñ Situaci√≥n:</strong><br>${caseData.caso}</div>
                            <div style="background: #fef3c7; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;"><strong>‚ùì Pregunta:</strong><br>${caseData.pregunta}</div>
                            <div style="background: #ecfeff; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;"><strong>üí° Pistas:</strong><br>${caseData.pistas.map(p => `‚Ä¢ ${p}`).join('<br>')}</div>
                            <textarea id="proCaseAnswer" placeholder="Tu respuesta..." style="width: 100%; min-height: 100px; padding: 0.75rem; border: 2px solid var(--border-color); border-radius: 8px; margin-bottom: 0.75rem;"></textarea>
                            <button class="btn" onclick="checkProCase('${article}')" style="width: 100%; background: #059669;">‚úÖ Verificar</button>
                            <div id="proCaseFeedback"></div>
                        </div>
                    `;
                }
            } catch (error) {
                output.innerHTML = `<div style="background: #fee2e2; padding: 1rem; border-radius: 8px; margin-top: 1rem;">‚ùå Error</div>`;
            }
        }

        async function checkProCase(article) {
            const answer = document.getElementById('proCaseAnswer').value.trim();
            if (!answer) {
                showProNotification('‚ö†Ô∏è Escribe respuesta', 'warning');
                return;
            }
            
            const feedback = document.getElementById('proCaseFeedback');
            feedback.innerHTML = `<div style="margin-top: 1rem; text-align: center;">ü§ñ Analizando...</div>`;
            
            try {
                const response = await fetchWithRetry("https://api.anthropic.com/v1/messages", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        model: "claude-sonnet-4-20250514",
                        max_tokens: 500,
                        messages: [{
                            role: "user",
                            content: `Eval√∫a: "${answer}". JSON: {"nota":8,"aciertos":["bien"],"mejoras":["mejorar"]}`
                        }]
                    })
                });
                
                const data = await response.json();
                const match = data.content[0].text.match(/\{[\s\S]*\}/);
                
                if (match) {
                    const result = JSON.parse(match[0]);
                    const color = result.nota >= 7 ? '#059669' : '#f59e0b';
                    feedback.innerHTML = `
                        <div style="margin-top: 1rem; background: white; border: 3px solid ${color}; border-radius: 12px; padding: 1rem;">
                            <div style="text-align: center; font-size: 2rem; font-weight: 700; color: ${color}; margin-bottom: 0.75rem;">${result.nota}/10</div>
                            <div style="background: #dcfce7; padding: 0.5rem; border-radius: 6px; margin-bottom: 0.5rem; font-size: 0.9rem;"><strong>‚úÖ</strong> ${result.aciertos.join(', ')}</div>
                            ${result.mejoras.length > 0 ? `<div style="background: #fef3c7; padding: 0.5rem; border-radius: 6px; font-size: 0.9rem;"><strong>üí°</strong> ${result.mejoras.join(', ')}</div>` : ''}
                        </div>
                    `;
                }
            } catch (error) {
                feedback.innerHTML = `<div style="margin-top: 1rem; color: #dc2626;">‚ùå Error</div>`;
            }
        }

        // ASISTENTE IA
        async function sendProAI() {
            const input = document.getElementById('proAIChatInput');
            const message = input.value.trim();
            if (!message) return;
            
            addProAIMessage(message, 'user');
            input.value = '';
            
            const container = document.getElementById('proAIChatContainer');
            const id = 'ai-' + Date.now();
            container.innerHTML += `<div id="${id}" style="background: var(--bg-card); border-radius: 8px; padding: 0.75rem; margin-bottom: 0.75rem;"><div style="display: flex; gap: 0.5rem;"><div>ü§ñ</div><div style="color: var(--text-secondary); font-size: 0.9rem;">Escribiendo...</div></div></div>`;
            container.scrollTop = container.scrollHeight;
            
            try {
                const response = await fetchWithRetry("https://api.anthropic.com/v1/messages", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        model: "claude-sonnet-4-20250514",
                        max_tokens: 600,
                        messages: [...proAIChatHistory, { role: "user", content: message }],
                        system: "Tutor de derecho espa√±ol. Conciso y claro."
                    })
                });
                
                const data = await response.json();
                const aiMsg = data.content[0].text;
                
                document.getElementById(id).remove();
                addProAIMessage(aiMsg, 'assistant');
                
                proAIChatHistory.push({ role: "user", content: message }, { role: "assistant", content: aiMsg });
                if (proAIChatHistory.length > 16) proAIChatHistory = proAIChatHistory.slice(-16);
                
            } catch (error) {
                document.getElementById(id).remove();
                addProAIMessage('‚ùå Error', 'error');
            }
        }

        function addProAIMessage(text, type) {
            const container = document.getElementById('proAIChatContainer');
            if (container.querySelector('[style*="text-align: center"]')) container.innerHTML = '';
            
            const styles = {
                user: { bg: '#dbeafe', icon: 'üë§', align: 'right' },
                assistant: { bg: 'var(--bg-card)', icon: 'ü§ñ', align: 'left' },
                error: { bg: '#fee2e2', icon: '‚ö†Ô∏è', align: 'left' }
            };
            
            const s = styles[type];
            container.innerHTML += `
                <div style="display: flex; justify-content: ${s.align === 'right' ? 'flex-end' : 'flex-start'}; margin-bottom: 0.75rem;">
                    <div style="background: ${s.bg}; border-radius: 8px; padding: 0.75rem; max-width: 85%;">
                        <div style="display: flex; gap: 0.5rem; font-size: 0.9rem;">
                            <div style="font-size: 1.2rem;">${s.icon}</div>
                            <div style="line-height: 1.5;">${text.replace(/\n/g, '<br>')}</div>
                        </div>
                    </div>
                </div>
            `;
            container.scrollTop = container.scrollHeight;
        }

        function proQuickAI(preset) {
            document.getElementById('proAIChatInput').value = preset;
            sendProAI();
        }

        function showProNotification(message, type = 'info') {
            const colors = { success: '#059669', error: '#dc2626', warning: '#f59e0b', info: '#0891b2' };
            const notif = document.createElement('div');
            notif.style.cssText = `position: fixed; top: 20px; right: 20px; background: ${colors[type]}; color: white; padding: 1rem 1.5rem; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); z-index: 10000; font-weight: 600; font-size: 0.95rem;`;
            notif.textContent = message;
            document.body.appendChild(notif);
            setTimeout(() => {
                notif.style.opacity = '0';
                notif.style.transition = 'opacity 0.3s';
                setTimeout(() => notif.remove(), 300);
            }, 3000);
        }

    </script>
</body>
</html>
